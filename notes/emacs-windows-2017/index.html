<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{from:"wordpress",title:"Emacs: Windowsでやっていく2017",date:"2017-12-08T00:00:08.000Z",tags:["advent"],slug:"emacs-windows-2017",html:"\u003Cp\u003Eこの記事は\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Fadvent-calendar\u002F2017\u002Femacs\"\u003EEmacs Advent Calendar 2017\u003C\u002Fa\u003Eの第8日目の記事として書かれました。\n第7日目は\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Fyynozk\"\u003Eyynozk\u003C\u002Fa\u003Eさんによる「\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Fyynozk\u002Fitems\u002F36a590b49a9237907335\"\u003EEmacs の org-mode は表計算もできてしまう\u003C\u002Fa\u003E」です。\n第9日目は\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Ftm_tn\"\u003Etm_tn\u003C\u002Fa\u003Eさんによる記事の予定です。「何か書きます」とのこと。\u003C\u002Fp\u003E\n\u003C!--more--\u003E\n\u003Cp\u003Eまた騙されてWindowsに戻ってきてしまった。\u003C\u002Fp\u003E\n\u003Cp\u003E先日買ったノートパソコンはMicrosoft Surface Book 2である。\n性能も申し分ないし、タッチスクリーンの完成度は最高。てか267 dpiて。うちにある外付けモニタが馬鹿みたいに見えてしまって逆に困るレベルである。\nとは言え誤算がひとつだけあって、このサーフェスブックにはマッキントッシュは入らないらしい。これでは★一つしかつけられそうにない。\nインタネーットの情報では入ると聞いていたのだが、よくよく見てみるとSurface Bookの話であった。これはSurface Book 2。そのあたりで差が出たのだと思う。\u003C\u002Fp\u003E\n\u003Cp\u003E冗談はさておき、しかしWindowsも悪くないものだ。\nWindows上でEmacsユーザとしてやっていくことに関しては、もう5年以上のキャリアがある。\n昔はUbuntu VM (VirtualBox) とX転送で頑張ったり、前C++とMSBuildでOSを書いていた時は普通にWindows版のGNU Emacsを使ったりしていたが、今回は最近めでたく正式リリースになったWindows Subsystem for Linux (WSL, 通称Bash on Ubuntu on Windows) を使って快適な作業環境を構築したいと思う。\u003C\u002Fp\u003E\n\u003Ch2\u003E1. WSLをセットアップする\u003C\u002Fh2\u003E\n\u003Cp\u003EWSLが何であるか、どうやってセットアップするかについてはインターネットで検索してもらいたい。\n今回は初めてのインストールなのでBeta版を削除するなどの些細なことは気にしなくて良い。\nとにかくMicrosoft Storeでアプリを導入するのと同じ感覚でUbuntuが使えるようになる。すばらしい。\u003C\u002Fp\u003E\n\u003Ch2\u003E2. Emacsを導入する\u003C\u002Fh2\u003E\n\u003Cp\u003Eさて、無事Ubuntu 16.04.3が導入された。早速Emacsを導入したいが、どのバージョンを導入するか考える必要がある。\u003C\u002Fp\u003E\n\u003Cp\u003EEmacs 24で満足できる人は、何も考えずに\u003Ccode\u003Eapt install emacs\u003C\u002Fcode\u003Eするだけで無事Emacsが導入できる。\u003C\u002Fp\u003E\n\u003Cp\u003EEmacs 25を導入したい場合は、いろいろ手段はあるがkelleykのPPMを追加するのが一番簡単だろう。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Eadd-apt-repository ppa:kelleyk\u002Femacs\napt update\napt install emacs25\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEmacs 27を導入したいなら、Ubunt Emacs Lisp teamの公開している\u003Ca href=\"https:\u002F\u002Flaunchpad.net\u002F~ubuntu-elisp\u002F+archive\u002Fubuntu\u002Fppa\"\u003EPPM\u003C\u002Fa\u003Eでemacs-snapshotを追加することになるだろうか。\n開発中のバージョンであり高い頻度で更新される。\u003C\u002Fp\u003E\n\u003Cp\u003EEmacs 26を導入するとなると、もうビルドするしかないのではないか？\n幸い最近のWSLはかなり安定してきておりdependencyを正しく導入すると問題なくビルドできる。\nEmacsのソースを管理するgitレポジトリは巨大なのでfetchを最小限に抑えるとかなり時間短縮になる (cf. \u003Ca href=\"\u002F\u002Fyo.eki.do\u002Fnotes\u002Fgit-only-single-commit\"\u003Eコミット・タグを指定してその時点でのツリーだけをgit cloneしてくる | 葉月夜堂\u003C\u002Fa\u003E)。\ndependencyの導入まで合わせて、こんな感じ。\u003C\u002Fp\u003E\n\u003Cscript src=\"https:\u002F\u002Fgist.github.com\u002Fkissge\u002Fe925a60437aacac5475673c70bc496e8.js\"\u003E\u003C\u002Fscript\u003E\n\u003Ch2\u003E3. Xサーバを導入する\u003C\u002Fh2\u003E\n\u003Cp\u003E最後にXサーバを導入すると完璧だ。\nもちろんターミナルさえあれば何もいらないというハードコアな諸兄にとっては不要だろう。\nしかし、GUIのほうが使える操作が増えるし使いやすいので個人的にはここまでおすすめしたい。\u003C\u002Fp\u003E\n\u003Cp\u003E以前はXmingのフリー版 (Public Domain Release) かCygwin\u002FXらへんが定番だったような気がする。\n調べたところVcxsrvかXmingの寄付版 (フリー版はこのソフトウェアの10年前のバージョン) を使うのが今風のようである。\n初めて名前を聞くので今回は\u003Ca href=\"https:\u002F\u002Fsourceforge.net\u002Fprojects\u002Fvcxsrv\u002F\"\u003EVcxsrv\u003C\u002Fa\u003Eを導入してみたが、今のところ全く不安定さを感じる場面は無い。\nGitHubを見ると更新が2年止まっているように見えるが、Sourceforgeではかなりアクティブにリリースされているようだ。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E追記 (12\u002F10)\u003C\u002Fstrong\u003E: VcXsrvを起動中にディスプレイの一つを切断するとVcXsrvがクラッシュすることがあるような気がします。\u003C\u002Fp\u003E\n\u003Cp\u003Eさて、ここまでセットアップを終えると無事GUI版のEmacsが使えるようになっているはずである。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003EDISPLAY=:0 emacs\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cimg src=\"\u002Fimages\u002Fuploads\u002F2017\u002F12\u002Femacs1.png\" alt=\"\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Eここからはもう少し細かいカスタマイズをしていく。\u003C\u002Fp\u003E\n\u003Ch2\u003Eスケーリング設定を切る\u003C\u002Fh2\u003E\n\u003Cp\u003Eさて、Surface Book 2はいわゆるhigh-DPIディスプレイである。\nあまりに1ピクセル（ソフトウェアから見た）の寸法（人間の目から見た）が小さすぎるので、工場出荷時にはスケーリングが200%に設定されている。\n一方Vcxsrvは（ざっくり言うと）X転送ということでクライアント (Linux) 側でレンダリングされたビットマップをWindows上で表示するということをしている。\nVcxsrvの描画するウィンドウはWindowsのスケーリングをかけると単に画像が大きくなってしまってあまり見栄えがよろしくない、ということになる（ざっくり言うと）。\nというわけでVcxsrv.exeを適切に設定してこのスケーリング設定を無効化してしまおう。\nまずVcxsrv.exeのプロパティを表示する。ファイル自体は、Vcxsrvへのショートカットを右クリックして “Open file location” するのを繰り返して探し出すか、おそらくは\u003Ccode\u003EC:\\Program Files\\VcXsrv\u003C\u002Fcode\u003Eにあるだろうから直接探す。\nそして “Compatibility” タブの “Override high DPI scaling behavior. Scaling performed by:” の項目を “Application” に変えてしまえばOK。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg src=\"\u002Fimages\u002Fuploads\u002F2017\u002F12\u002Femacs4.png\" alt=\"\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E追記 (12\u002F10)\u003C\u002Fstrong\u003E: これ、やるのとやらないのでどちらが「きれい」か、あまり自明ではないですね。試行錯誤中です。切るとタイトルバーが馬鹿みたいに大きくなるのが癪なので再び有効にしてみているところ。\u003C\u002Fp\u003E\n\u003Ch2\u003Eいい感じの日本語フォントを導入する\u003C\u002Fh2\u003E\n\u003Cp\u003E何もしなくても日本語は表示されるはずである。が、句読点の位置が中国語のそれだったり、ちょっといまいち。\n導入の手軽さもこみでGoogle\u002FAdobe謹製のNotoフォントをおすすめする。\nX転送ってどっちにフォント入れればいいのか忘れるけれど、今どきはとりあえずクライアント (Linux) 側ということになっている。\nというわけでインストールはaptで簡単に。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Eapt install fonts-noto-cjk\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEmacsのほうはこんな感じで設定を。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003E(set-fontset-font &quot;fontset-default&quot; 'japanese-jisx0208 '(&quot;Noto Sans CJK JP Medium&quot; . &quot;iso10646-1&quot;))\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2\u003E日本語入力\u003C\u002Fh2\u003E\n\u003Cp\u003E表示ときたら次は入力。\n今回も使い慣れたmozc (Google日本語入力のオープンソース版)　とemacs-mozc-binでいく。\nまずターミナルでサーバをインストールする。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Eapt install emacs-mozc-bin\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EEmacs側ではまず\u003Ca href=\"https:\u002F\u002Fraw.githubusercontent.com\u002Fgoogle\u002Fmozc\u002Fmaster\u002Fsrc\u002Funix\u002Femacs\u002Fmozc.el\"\u003Emozc.el\u003C\u002Fa\u003Eを手に入れ、\u003Ccode\u003Eload-path\u003C\u002Fcode\u003Eの通っているディレクトリに置く。\nそして\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003E(setq default-input-method &quot;japanese-mozc&quot;)\n(require 'mozc)\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eあとは\u003Ccode\u003EM-x toggle-input-method\u003C\u002Fcode\u003EでIMEのオンオフが切り替えられる。好みに応じて\u003Ccode\u003Eglobal-set-key\u003C\u002Fcode\u003Eしておこう。\nちなみに全角半角キーは\u003Ccode\u003E(kbd &quot;&lt;zenkaku-hankaku&gt;&quot;)\u003C\u002Fcode\u003Eで指定できる。\u003C\u002Fp\u003E\n\u003Cp\u003E蛇足だが個人的に気に入っているのでgnome-terminalも導入した（めちゃくちゃdependencyが多かった）。\nこちらの日本語入力はいつものUbuntuと同じとはいかない。\n残念ながらibusはうまく動かないようである。\n今回は妥協してuim-fepとanthyを使うことにした。\nこんな感じでターミナルの一番下の行を1行占領してしまうが、しょうがない。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg src=\"\u002Fimages\u002Fuploads\u002F2017\u002F12\u002Femacs2.png\" alt=\"\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Egnome-terminalの設定で、起動するシェルをuim-fepにしておこう。\n.bashrcで呼び出すように設定しても良いが、二重起動しないようにいろいろ頭を使うのが面倒だった。\nEmacsの\u003Ccode\u003Eshell\u003C\u002Fcode\u003Eなどで起動しないで欲しいという理由もある。\u003C\u002Fp\u003E\n\u003Ch2\u003EWindowsから直接Emacsを起動する\u003C\u002Fh2\u003E\n\u003Cp\u003Eさて、毎回Emacsを起動するためにWSLのターミナルを呼び出すのは面倒くさい。\nWindowsからWSL上のコマンドを実行するのは簡単だ。\nWindows + Rキーで開くファイル名を指定して実行 (Run) ダイアログなどからbashを呼び出すだけで良い。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Ebash -c &quot;DISPLAY=:0 emacs&quot;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eしかし、これだと「黒画面」が表示しっぱなしになってしまう。\nEmacsが終了するまでbash.exeのウィンドウが裏に表示されたままになってしまうのである。\nそこでひと工夫加えてこうすれば良い。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Ebash -c &quot;DISPLAY=:0 emacs &amp;&quot;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E良い……んじゃないかと思う。自分のショートカット見たらこれじゃなくてrun.exe使ってて、あれ、&amp;じゃダメな理由あったんだっけ……忘れた……。\u003C\u002Fp\u003E\n\u003Cp\u003Eついでに、起動時のデフォルトディレクトリが変なディレクトリになって気に入らないので\u003Ccode\u003Ebash -c &quot;cd; DISPLAY=:0 emacs &amp;&quot;\u003C\u002Fcode\u003Eなどとしてしまっても良い。\u003C\u002Fp\u003E\n\u003Cp\u003E言うまでもないことだがGUIウィンドウを使いたければXサーバが立っている必要がある。\nWindowsの起動時に自動で起動するようにするのが簡単だろう。\nエクスプローラのアドレスバーで\u003Ccode\u003Eshell:startup\u003C\u002Fcode\u003Eと指定すると開くディレクトリにVcxsrvへのショートカットを置くだけである。\u003C\u002Fp\u003E\n\u003Ch2\u003Eもちろんtramp-modeも使え……\u003C\u002Fh2\u003E\n\u003Cp\u003Eこれで概ね開発環境は整った！\nあとはSSHの設定を適切に行いいつものようにtramp-modeで開発用のLinuxサーバのファイルを編集するだけである (cf. \u003Ca href=\"\u002F\u002Fyo.eki.do\u002Fnotes\u002Ftramp-mode\"\u003EEmacs: まだターミナルで消耗してるの？ | 葉月夜堂\u003C\u002Fa\u003E)。\u003C\u002Fp\u003E\n\u003Cp\u003Eが、ここで重大な問題が発生する。\u003C\u002Fp\u003E\n\u003Cp\u003Etramp-modeを使ってリモートファイルを編集し保存しようとすると、“Decoding remote file `xxxx’ using `xxxx’” のところでEmacsがハングしてしまうのである。\nおまけに編集中のファイルは消滅してしまう。最悪だ。\u003C\u002Fp\u003E\n\u003Cp\u003Eうーん…………。\nWSL, sshfsもまだ使えないみたいだし……。\u003C\u002Fp\u003E\n\u003Cp\u003Eうーん…………。\u003C\u002Fp\u003E\n\u003Cp\u003EEmacsやめるか……。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Eというわけで他のエディタを導入してみる。\n実を言うと時代遅れのEmacsなんてはやく辞めたかったのである。\n時代はElectron製イケてるエディタやな！！\u003C\u002Fp\u003E\n\u003Cp\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Eが、やっぱりダメ。\nエディタを起動したらまず\u003Ccode\u003Efind-file\u003C\u002Fcode\u003Eしたい。\nGUIのファイルオープンダイアログなんか使いたくない。\nプロジェクトにファイルがありませんじゃない。IDEじゃなくてエディタが欲しいんだよ。\u003C\u002Fp\u003E\n\u003Cp\u003Eてかリモートファイル編集がないって何？💢\nファイルをダウンロードして編集して保存してアップロードするのか？sshしてターミナルで操作の限定された状況でファイルを編集するのか？サーバを立てるごとに環境構築して？\n21世紀なのに？え？\u003C\u002Fp\u003E\n\u003Cp\u003EというわけでやっぱりEmacsを使うしか無い（個人の感想です）という結論に。\n個人の感想ですよ。\nAtomの\u003Ca href=\"https:\u002F\u002Fatom.io\u002Fpackages\u002Fftp-remote-edit\"\u003Eftp-remote-edit\u003C\u002Fa\u003Eはいい線いってると思いますよ。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Eともかく気を取り直して頑張ってtramp-modeをデバッグする。\nどうやらEmacs 25, 26, 27いずれも同様の問題があるらしいことがわかった。\n（蛇足だがEmacs 26, 27だとGUIで文字が描画されず使い物にならなかった……gtk+ 2, 3両方試してもダメ。あとtrampもファイルを開くたびになんかエラー出る）\u003C\u002Fp\u003E\n\u003Cp\u003E基本通りedebugをアタッチしてみると、\u003Ccode\u003Eprocess-send-string\u003C\u002Fcode\u003Eでbase64エンコードした文字列を送りリモートシェルでデコードする部分で処理が止まってしまうことがわかる。\nこの問題は比較的小さいファイルを編集するときには起きないようだ。\nそこで、一回に送る文字列の長さを制限してみる。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003E(custom-set-variables '(tramp-chunksize 1024))\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E数字は適当である。\nが、これがうまくいった。\nとりあえず今のところ問題は再発していない（10240はダメだった）。\u003C\u002Fp\u003E\n\u003Cp\u003E一応\u003Ccode\u003Etramp-chunksize\u003C\u002Fcode\u003EをいじるのはWSL上だけに制限しておこう。\nWSLかどうか判定するのはこういう感じで。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003E(string-match-p &quot;Microsoft&quot; (shell-command-to-string &quot;uname -r&quot;))\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eというわけでどうにか開発環境として日常的に使えるように出来た。\nこれがEmacsの問題だったのかtramp-modeなのかWSLなのか、よくわからない。どこかに報告したほうがいいのかもしれない。\nいずれにせよこれでコードが書ける。\nよかった。\u003C\u002Fp\u003E\n\u003Cp\u003E大変なこともあったけど、2017年現在、Windowsでやっていけそうです。\nしかも（一応）案外簡単に。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg src=\"\u002Fimages\u002Fuploads\u002F2017\u002F12\u002Femacs3.png\" alt=\"\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003EまたEmacsを卒業しそびれてしまったねえ。\u003C\u002Fp\u003E\n",headline:"この記事は[Emacs Advent Calendar 2017](https:\u002F\u002Fqiita.com\u002Fadvent-calendar\u002F2017\u002Femacs)の第8日目の記事として書かれました。 第7"},historyURL:"https:\u002F\u002Fgithub.com\u002Fkissge\u002Fyo.eki.do\u002Fcommits\u002Fmaster\u002Fnotes\u002Femacs-windows-2017.md"}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.f2dd095d.js"}catch(e){main="/client/legacy/client.a96fd353.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.4.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <link href=client/client-9e2cfc0b.css rel=stylesheet><link href=client/[slug]-cf2c2a67.css rel=stylesheet> <title>Emacs: Windowsでやっていく2017 - 2017-12-08 | 葉月夜堂</title><script src="https://www.googletagmanager.com/gtag/js?id=UA-45102742-1" async data-svelte=svelte-a2kvt3></script><meta content=article data-svelte=svelte-14mnzgr property=og:type><meta content="Emacs: Windowsでやっていく2017 - 2017-12-08 | 葉月夜堂" data-svelte=svelte-14mnzgr property=og:title><meta content="この記事は[Emacs Advent Calendar 2017](https://qiita.com/advent-calendar/2017/emacs)の第8日目の記事として書かれました。 第7" data-svelte=svelte-14mnzgr property=og:description><meta content=葉月夜堂 data-svelte=svelte-14mnzgr property=og:site_name><meta content=https://yo.eki.do/images/default.png data-svelte=svelte-14mnzgr property=og:image> <link href=/client/client.f2dd095d.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-9e2cfc0b.css rel=preload as=style><link href=/client/[slug].ee68746d.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/[slug]-cf2c2a67.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-1vowuxu><ul class=svelte-1vowuxu><li class=svelte-1vowuxu><a href=. class=svelte-1vowuxu rel=prefetch>articles</a></li> <li class=svelte-1vowuxu><a href=about class=svelte-1vowuxu rel=prefetch>about</a></ul> </nav> <main class=svelte-gph4rb> <header class=svelte-1xsha26><div class="svelte-1xsha26 img-header" style=""></div> <h1 class=svelte-1xsha26>Emacs: Windowsでやっていく2017</h1> <time class=svelte-1xsha26>2017-12-08T09:00:08+09:00</time> <div class=tags><div class="svelte-1xsha26 tag">#advent</div></div> <p class="svelte-1xsha26 history"><a href=https://github.com/kissge/yo.eki.do/commits/master/notes/emacs-windows-2017.md>更新履歴</a></header> <div class="svelte-1xsha26 callout">この記事は以前別のところにあったものを移してきたものです。完璧に移植できておらず、表示が崩れているかもしれません。 </div> <div class="svelte-1xsha26 content"><p>この記事は<a href=https://qiita.com/advent-calendar/2017/emacs>Emacs Advent Calendar 2017</a>の第8日目の記事として書かれました。 第7日目は<a href=https://qiita.com/yynozk>yynozk</a>さんによる「<a href=https://qiita.com/yynozk/items/36a590b49a9237907335>Emacs の org-mode は表計算もできてしまう</a>」です。 第9日目は<a href=https://qiita.com/tm_tn>tm_tn</a>さんによる記事の予定です。「何か書きます」とのこと。</p> <p>また騙されてWindowsに戻ってきてしまった。</p> <p>先日買ったノートパソコンはMicrosoft Surface Book 2である。 性能も申し分ないし、タッチスクリーンの完成度は最高。てか267 dpiて。うちにある外付けモニタが馬鹿みたいに見えてしまって逆に困るレベルである。 とは言え誤算がひとつだけあって、このサーフェスブックにはマッキントッシュは入らないらしい。これでは★一つしかつけられそうにない。 インタネーットの情報では入ると聞いていたのだが、よくよく見てみるとSurface Bookの話であった。これはSurface Book 2。そのあたりで差が出たのだと思う。</p> <p>冗談はさておき、しかしWindowsも悪くないものだ。 Windows上でEmacsユーザとしてやっていくことに関しては、もう5年以上のキャリアがある。 昔はUbuntu VM (VirtualBox) とX転送で頑張ったり、前C++とMSBuildでOSを書いていた時は普通にWindows版のGNU Emacsを使ったりしていたが、今回は最近めでたく正式リリースになったWindows Subsystem for Linux (WSL, 通称Bash on Ubuntu on Windows) を使って快適な作業環境を構築したいと思う。</p> <h2>1. WSLをセットアップする</h2> <p>WSLが何であるか、どうやってセットアップするかについてはインターネットで検索してもらいたい。 今回は初めてのインストールなのでBeta版を削除するなどの些細なことは気にしなくて良い。 とにかくMicrosoft Storeでアプリを導入するのと同じ感覚でUbuntuが使えるようになる。すばらしい。</p> <h2>2. Emacsを導入する</h2> <p>さて、無事Ubuntu 16.04.3が導入された。早速Emacsを導入したいが、どのバージョンを導入するか考える必要がある。</p> <p>Emacs 24で満足できる人は、何も考えずに<code>apt install emacs</code>するだけで無事Emacsが導入できる。</p> <p>Emacs 25を導入したい場合は、いろいろ手段はあるがkelleykのPPMを追加するのが一番簡単だろう。</p> <pre><code>add-apt-repository ppa:kelleyk/emacs
apt update
apt install emacs25
</code></pre> <p>Emacs 27を導入したいなら、Ubunt Emacs Lisp teamの公開している<a href=https://launchpad.net/~ubuntu-elisp/+archive/ubuntu/ppa>PPM</a>でemacs-snapshotを追加することになるだろうか。 開発中のバージョンであり高い頻度で更新される。</p> <p>Emacs 26を導入するとなると、もうビルドするしかないのではないか？ 幸い最近のWSLはかなり安定してきておりdependencyを正しく導入すると問題なくビルドできる。 Emacsのソースを管理するgitレポジトリは巨大なのでfetchを最小限に抑えるとかなり時間短縮になる (cf. <a href=//yo.eki.do/notes/git-only-single-commit>コミット・タグを指定してその時点でのツリーだけをgit cloneしてくる | 葉月夜堂</a>)。 dependencyの導入まで合わせて、こんな感じ。</p> <script src=https://gist.github.com/kissge/e925a60437aacac5475673c70bc496e8.js></script> <h2>3. Xサーバを導入する</h2> <p>最後にXサーバを導入すると完璧だ。 もちろんターミナルさえあれば何もいらないというハードコアな諸兄にとっては不要だろう。 しかし、GUIのほうが使える操作が増えるし使いやすいので個人的にはここまでおすすめしたい。</p> <p>以前はXmingのフリー版 (Public Domain Release) かCygwin/Xらへんが定番だったような気がする。 調べたところVcxsrvかXmingの寄付版 (フリー版はこのソフトウェアの10年前のバージョン) を使うのが今風のようである。 初めて名前を聞くので今回は<a href=https://sourceforge.net/projects/vcxsrv/ >Vcxsrv</a>を導入してみたが、今のところ全く不安定さを感じる場面は無い。 GitHubを見ると更新が2年止まっているように見えるが、Sourceforgeではかなりアクティブにリリースされているようだ。</p> <p><strong>追記 (12/10)</strong>: VcXsrvを起動中にディスプレイの一つを切断するとVcXsrvがクラッシュすることがあるような気がします。</p> <p>さて、ここまでセットアップを終えると無事GUI版のEmacsが使えるようになっているはずである。</p> <pre><code>DISPLAY=:0 emacs
</code></pre> <p><img alt="" src=/images/uploads/2017/12/emacs1.png></p> <p>ここからはもう少し細かいカスタマイズをしていく。</p> <h2>スケーリング設定を切る</h2> <p>さて、Surface Book 2はいわゆるhigh-DPIディスプレイである。 あまりに1ピクセル（ソフトウェアから見た）の寸法（人間の目から見た）が小さすぎるので、工場出荷時にはスケーリングが200%に設定されている。 一方Vcxsrvは（ざっくり言うと）X転送ということでクライアント (Linux) 側でレンダリングされたビットマップをWindows上で表示するということをしている。 Vcxsrvの描画するウィンドウはWindowsのスケーリングをかけると単に画像が大きくなってしまってあまり見栄えがよろしくない、ということになる（ざっくり言うと）。 というわけでVcxsrv.exeを適切に設定してこのスケーリング設定を無効化してしまおう。 まずVcxsrv.exeのプロパティを表示する。ファイル自体は、Vcxsrvへのショートカットを右クリックして “Open file location” するのを繰り返して探し出すか、おそらくは<code>C:\Program Files\VcXsrv</code>にあるだろうから直接探す。 そして “Compatibility” タブの “Override high DPI scaling behavior. Scaling performed by:” の項目を “Application” に変えてしまえばOK。</p> <p><img alt="" src=/images/uploads/2017/12/emacs4.png></p> <p><strong>追記 (12/10)</strong>: これ、やるのとやらないのでどちらが「きれい」か、あまり自明ではないですね。試行錯誤中です。切るとタイトルバーが馬鹿みたいに大きくなるのが癪なので再び有効にしてみているところ。</p> <h2>いい感じの日本語フォントを導入する</h2> <p>何もしなくても日本語は表示されるはずである。が、句読点の位置が中国語のそれだったり、ちょっといまいち。 導入の手軽さもこみでGoogle/Adobe謹製のNotoフォントをおすすめする。 X転送ってどっちにフォント入れればいいのか忘れるけれど、今どきはとりあえずクライアント (Linux) 側ということになっている。 というわけでインストールはaptで簡単に。</p> <pre><code>apt install fonts-noto-cjk
</code></pre> <p>Emacsのほうはこんな感じで設定を。</p> <pre><code>(set-fontset-font "fontset-default" 'japanese-jisx0208 '("Noto Sans CJK JP Medium" . "iso10646-1"))
</code></pre> <h2>日本語入力</h2> <p>表示ときたら次は入力。 今回も使い慣れたmozc (Google日本語入力のオープンソース版)　とemacs-mozc-binでいく。 まずターミナルでサーバをインストールする。</p> <pre><code>apt install emacs-mozc-bin
</code></pre> <p>Emacs側ではまず<a href=https://raw.githubusercontent.com/google/mozc/master/src/unix/emacs/mozc.el>mozc.el</a>を手に入れ、<code>load-path</code>の通っているディレクトリに置く。 そして</p> <pre><code>(setq default-input-method "japanese-mozc")
(require 'mozc)
</code></pre> <p>あとは<code>M-x toggle-input-method</code>でIMEのオンオフが切り替えられる。好みに応じて<code>global-set-key</code>しておこう。 ちなみに全角半角キーは<code>(kbd "&lt;zenkaku-hankaku>")</code>で指定できる。</p> <p>蛇足だが個人的に気に入っているのでgnome-terminalも導入した（めちゃくちゃdependencyが多かった）。 こちらの日本語入力はいつものUbuntuと同じとはいかない。 残念ながらibusはうまく動かないようである。 今回は妥協してuim-fepとanthyを使うことにした。 こんな感じでターミナルの一番下の行を1行占領してしまうが、しょうがない。</p> <p><img alt="" src=/images/uploads/2017/12/emacs2.png></p> <p>gnome-terminalの設定で、起動するシェルをuim-fepにしておこう。 .bashrcで呼び出すように設定しても良いが、二重起動しないようにいろいろ頭を使うのが面倒だった。 Emacsの<code>shell</code>などで起動しないで欲しいという理由もある。</p> <h2>Windowsから直接Emacsを起動する</h2> <p>さて、毎回Emacsを起動するためにWSLのターミナルを呼び出すのは面倒くさい。 WindowsからWSL上のコマンドを実行するのは簡単だ。 Windows + Rキーで開くファイル名を指定して実行 (Run) ダイアログなどからbashを呼び出すだけで良い。</p> <pre><code>bash -c "DISPLAY=:0 emacs"
</code></pre> <p>しかし、これだと「黒画面」が表示しっぱなしになってしまう。 Emacsが終了するまでbash.exeのウィンドウが裏に表示されたままになってしまうのである。 そこでひと工夫加えてこうすれば良い。</p> <pre><code>bash -c "DISPLAY=:0 emacs &"
</code></pre> <p>良い……んじゃないかと思う。自分のショートカット見たらこれじゃなくてrun.exe使ってて、あれ、&じゃダメな理由あったんだっけ……忘れた……。</p> <p>ついでに、起動時のデフォルトディレクトリが変なディレクトリになって気に入らないので<code>bash -c "cd; DISPLAY=:0 emacs &"</code>などとしてしまっても良い。</p> <p>言うまでもないことだがGUIウィンドウを使いたければXサーバが立っている必要がある。 Windowsの起動時に自動で起動するようにするのが簡単だろう。 エクスプローラのアドレスバーで<code>shell:startup</code>と指定すると開くディレクトリにVcxsrvへのショートカットを置くだけである。</p> <h2>もちろんtramp-modeも使え……</h2> <p>これで概ね開発環境は整った！ あとはSSHの設定を適切に行いいつものようにtramp-modeで開発用のLinuxサーバのファイルを編集するだけである (cf. <a href=//yo.eki.do/notes/tramp-mode>Emacs: まだターミナルで消耗してるの？ | 葉月夜堂</a>)。</p> <p>が、ここで重大な問題が発生する。</p> <p>tramp-modeを使ってリモートファイルを編集し保存しようとすると、“Decoding remote file `xxxx’ using `xxxx’” のところでEmacsがハングしてしまうのである。 おまけに編集中のファイルは消滅してしまう。最悪だ。</p> <p>うーん…………。 WSL, sshfsもまだ使えないみたいだし……。</p> <p>うーん…………。</p> <p>Emacsやめるか……。</p> <p></p> <p>というわけで他のエディタを導入してみる。 実を言うと時代遅れのEmacsなんてはやく辞めたかったのである。 時代はElectron製イケてるエディタやな！！</p> <p></p> <p>が、やっぱりダメ。 エディタを起動したらまず<code>find-file</code>したい。 GUIのファイルオープンダイアログなんか使いたくない。 プロジェクトにファイルがありませんじゃない。IDEじゃなくてエディタが欲しいんだよ。</p> <p>てかリモートファイル編集がないって何？💢 ファイルをダウンロードして編集して保存してアップロードするのか？sshしてターミナルで操作の限定された状況でファイルを編集するのか？サーバを立てるごとに環境構築して？ 21世紀なのに？え？</p> <p>というわけでやっぱりEmacsを使うしか無い（個人の感想です）という結論に。 個人の感想ですよ。 Atomの<a href=https://atom.io/packages/ftp-remote-edit>ftp-remote-edit</a>はいい線いってると思いますよ。</p> <p></p> <p>ともかく気を取り直して頑張ってtramp-modeをデバッグする。 どうやらEmacs 25, 26, 27いずれも同様の問題があるらしいことがわかった。 （蛇足だがEmacs 26, 27だとGUIで文字が描画されず使い物にならなかった……gtk+ 2, 3両方試してもダメ。あとtrampもファイルを開くたびになんかエラー出る）</p> <p>基本通りedebugをアタッチしてみると、<code>process-send-string</code>でbase64エンコードした文字列を送りリモートシェルでデコードする部分で処理が止まってしまうことがわかる。 この問題は比較的小さいファイルを編集するときには起きないようだ。 そこで、一回に送る文字列の長さを制限してみる。</p> <pre><code>(custom-set-variables '(tramp-chunksize 1024))
</code></pre> <p>数字は適当である。 が、これがうまくいった。 とりあえず今のところ問題は再発していない（10240はダメだった）。</p> <p>一応<code>tramp-chunksize</code>をいじるのはWSL上だけに制限しておこう。 WSLかどうか判定するのはこういう感じで。</p> <pre><code>(string-match-p "Microsoft" (shell-command-to-string "uname -r"))
</code></pre> <p>というわけでどうにか開発環境として日常的に使えるように出来た。 これがEmacsの問題だったのかtramp-modeなのかWSLなのか、よくわからない。どこかに報告したほうがいいのかもしれない。 いずれにせよこれでコードが書ける。 よかった。</p> <p>大変なこともあったけど、2017年現在、Windowsでやっていけそうです。 しかも（一応）案外簡単に。</p> <p><img alt="" src=/images/uploads/2017/12/emacs3.png></p> <p>またEmacsを卒業しそびれてしまったねえ。</p> </div> </main></div> 