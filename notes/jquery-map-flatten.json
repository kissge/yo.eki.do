{"from":"wordpress","title":"jQueryのmapは勝手にflattenする","date":"2016-12-27T21:08:02.000Z","slug":"jquery-map-flatten","html":"<!--more-->\n<p>jQueryの <code>map</code> は勝手に中身をflattenする。つまり、</p>\n<pre><code>&lt;ul&gt;\n    &lt;li&gt;a&lt;/li&gt;\n    &lt;li&gt;b&lt;/li&gt;\n&lt;/ul&gt;\n&lt;ul&gt;\n    &lt;li&gt;a&lt;/li&gt;\n    &lt;li&gt;b&lt;/li&gt;\n    &lt;li&gt;c&lt;/li&gt;\n&lt;/ul&gt;\n</code></pre>\n<p>というような構造があったときに</p>\n<pre><code>$('ul').map((index, element) =&gt; $(element).find('li').map((index, element) =&gt; $(element).text()).toArray())\n==&gt; [&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;] // not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\n</code></pre>\n<p>と勝手に入れ子になった配列がひとつの配列に変換されてしまう。\n一応これはバグではなく仕様のようだ（<a href=\"https://bugs.jquery.com/ticket/10541\">参考</a>）。\nどう対応するのがいいのかよく分からないが……dirty hackとしては戻り値をさらに配列でラップすると一応欲しいものは得られる。</p>\n<pre><code>$('ul').map((index, element) =&gt; [$(element).find('li').map((index, element) =&gt; $(element).text()).toArray()])\n==&gt; [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\n</code></pre>\n<p>うーん、やだなあ。\n同じ挙動は <code>jQuery.map</code> でも見られる。ただし引数の順番が逆だけど。</p>\n<pre><code>$.map($('ul'), (element, index) =&gt; $.map($(element).find('li'), (element, index) =&gt; $(element).text()))\n==&gt; [&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;] // not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\n\n$.map($('ul'), (element, index) =&gt; [$.map($(element).find('li'), (element, index) =&gt; $(element).text())])\n==&gt; [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\n</code></pre>\n<p>やめてほしい。</p>\n","headline":"<!--more--> jQueryの `map` は勝手に中身をflattenする。つまり、 <ul> <li>a</li> <li>b</li>"}