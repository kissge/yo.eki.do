{"from":"wordpress","title":"jQueryのmapは勝手にflattenする","date":"2016-12-27T21:08:02.000Z","type":"notes","slug":"jquery-map-flatten","html":"<!--more-->\n<p>jQueryの <code>map</code> は勝手に中身をflattenする。つまり、</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ul</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>a<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>b<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ul</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ul</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>a<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>b<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>c<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ul</span>&gt;</span>\n</code></pre>\n<p>というような構造があったときに</p>\n<pre><code class=\"hljs language-js\">$(<span class=\"hljs-string\">&#x27;ul&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()).<span class=\"hljs-title function_\">toArray</span>())\n==&gt; [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>] <span class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>\n</code></pre>\n<p>と勝手に入れ子になった配列がひとつの配列に変換されてしまう。\n一応これはバグではなく仕様のようだ（<a href=\"https://bugs.jquery.com/ticket/10541\">参考</a>）。\nどう対応するのがいいのかよく分からないが……dirty hackとしては戻り値をさらに配列でラップすると一応欲しいものは得られる。</p>\n<pre><code class=\"hljs language-js\">$(<span class=\"hljs-string\">&#x27;ul&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> [$(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()).<span class=\"hljs-title function_\">toArray</span>()])\n==&gt; [[<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>], [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>]]\n</code></pre>\n<p>うーん、やだなあ。\n同じ挙動は <code>jQuery.map</code> でも見られる。ただし引数の順番が逆だけど。</p>\n<pre><code class=\"hljs language-js\">$.<span class=\"hljs-title function_\">map</span>($(<span class=\"hljs-string\">&#x27;ul&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $.<span class=\"hljs-title function_\">map</span>($(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()))\n==&gt; [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>] <span class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>\n\n$.<span class=\"hljs-title function_\">map</span>($(<span class=\"hljs-string\">&#x27;ul&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> [$.<span class=\"hljs-title function_\">map</span>($(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>())])\n==&gt; [[<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>], [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>]]\n</code></pre>\n<p>やめてほしい。</p>\n","headline":"jQueryの map は勝手に中身をflattenする。つまり、&lt;ul&gt;    &lt;li&gt;a&lt;/li&gt;    &lt;li&gt;b&lt;/li&gt;&lt;/"}