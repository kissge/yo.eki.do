{"entity":{"name":"jQueryのmapは勝手にflattenする","nameSegmented":["jQueryの","mapは","勝手に","flattenする"],"kind":"note","urlPath":"/notes/jquery-map-flatten","historyURL":"https://github.com/kissge/yo.eki.do/commits/master/notes/jquery-map-flatten.md","lastModified":"2022-04-17T12:08:43.000Z","attributes":{"from":"wordpress","title":"jQueryのmapは勝手にflattenする","date":"2016-12-27T21:08:02.000Z"},"tags":[],"body":"<!--more-->\n\n<p>jQueryの <code>map</code> は勝手に中身をflattenする。つまり、</p>\n<pre><code class=\"language-html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ul</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>a<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>b<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ul</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ul</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>a<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>b<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span>&gt;</span>c<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ul</span>&gt;</span>\n</code></pre>\n<p>というような構造があったときに</p>\n<pre><code class=\"language-js\">$(<span class=\"hljs-string\">&#x27;ul&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()).<span class=\"hljs-title function_\">toArray</span>())\n==&gt; [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>] <span class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>\n</code></pre>\n<p>と勝手に入れ子になった配列がひとつの配列に変換されてしまう。一応これはバグではなく仕様のようだ（<a href=\"https://bugs.jquery.com/ticket/10541\">参考</a>）。どう対応するのがいいのかよく分からないが……dirty hackとしては戻り値をさらに配列でラップすると一応欲しいものは得られる。</p>\n<pre><code class=\"language-js\">$(<span class=\"hljs-string\">&#x27;ul&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> [$(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">index, element</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()).<span class=\"hljs-title function_\">toArray</span>()])\n==&gt; [[<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>], [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>]]\n</code></pre>\n<p>うーん、やだなあ。同じ挙動は <code>jQuery.map</code> でも見られる。ただし引数の順番が逆だけど。</p>\n<pre><code class=\"language-js\">$.<span class=\"hljs-title function_\">map</span>($(<span class=\"hljs-string\">&#x27;ul&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $.<span class=\"hljs-title function_\">map</span>($(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>()))\n==&gt; [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>] <span class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>\n\n$.<span class=\"hljs-title function_\">map</span>($(<span class=\"hljs-string\">&#x27;ul&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> [$.<span class=\"hljs-title function_\">map</span>($(element).<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-string\">&#x27;li&#x27;</span>), <span class=\"hljs-function\">(<span class=\"hljs-params\">element, index</span>) =&gt;</span> $(element).<span class=\"hljs-title function_\">text</span>())])\n==&gt; [[<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>], [<span class=\"hljs-string\">&quot;a&quot;</span>, <span class=\"hljs-string\">&quot;b&quot;</span>, <span class=\"hljs-string\">&quot;c&quot;</span>]]\n</code></pre>\n<p>やめてほしい。</p>\n","headline":"jQueryの map は勝手に中身をflattenする。つまり、&lt;ul&gt;    &lt;li&gt;a&lt;/li&gt;    &lt;li&gt;b&lt;/li&gt;&lt;/ul&gt;&lt;ul&gt;    &lt;li&gt;a&lt;/li&gt;    &lt;li&gt;b&lt;/li&gt;    &lt;li&gt;c&lt;/li&gt;&lt;/ul&gt;というような構造があったときに$(&#x27;ul&#x27;).map((index, element) =&gt; $(element).find(&#x27;li&#x27;).map((index, element) =&gt; $(element).text()).toArray())==&gt; [&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;] // not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot","links":{"to":{"urlPath":"/notes/jquery-map-flatten","entities":[]},"from":{"urlPath":"/notes/jquery-map-flatten","entities":[]},"kind":{"urlPath":"/notes/jquery-map-flatten","entities":[]}},"isEmpty":false}}