<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/images/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css" />
    <meta http-equiv="content-security-policy" content=""><title>jQueryのmapは勝手にflattenする - 2016-12-28 | 葉月夜堂</title><link href="https://twitter.com/p_km" rel="me" data-svelte="svelte-10crdf0">
    <link rel="webmention" href="https://webmention.io/sveltekit-prerender/webmention" data-svelte="svelte-10crdf0">
    <link rel="pingback" href="https://webmention.io/sveltekit-prerender/xmlrpc" data-svelte="svelte-10crdf0"><meta property="og:type" content="article" data-svelte="svelte-6t30ru"><meta property="og:title" content="jQueryのmapは勝手にflattenする - 2016-12-28 | 葉月夜堂" data-svelte="svelte-6t30ru"><meta property="og:description" content="jQueryの map は勝手に中身をflattenする。つまり、&amp;lt;ul&amp;gt;    &amp;lt;li&amp;gt;a&amp;lt;/li&amp;gt;    &amp;lt;li&amp;gt;b&amp;lt;/li&amp;gt;&amp;lt;/ul&amp;gt;&amp;lt;ul&amp;gt;    &amp;lt;li&amp;gt;a&amp;lt;/li&amp;gt;    &amp;lt;li&amp;gt;b&amp;lt;/li&amp;gt;    &amp;lt;li&amp;gt;c&amp;lt;/li&amp;gt;&amp;lt;/ul&amp;gt;というような構造があったときに$(&amp;#x27;ul&amp;#x27;).map((index, element) =&amp;gt; $(element).find(&amp;#x27;li&amp;#x27;).map((index, element) =&amp;gt; $(element).text()).toArray())==&amp;gt; [&amp;quot;a&amp;quot;, &amp;quot;b&amp;quot;, &amp;quot;a&amp;quot;, &amp;quot;b&amp;quot;, &amp;quot;c&amp;quot;] // not [[&amp;quot;a&amp;quot;, &amp;quot;b&amp;quot;], [&amp;quot;a&amp;quot;, &amp;quot;b&amp;quot;, &amp;quot" data-svelte="svelte-6t30ru"><meta property="og:site_name" content="葉月夜堂" data-svelte="svelte-6t30ru"><meta property="og:image" content="http://sveltekit-prerender/images/favicon.svg" data-svelte="svelte-6t30ru">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/__layout.svelte-f9a44566.css">
	<link rel="stylesheet" href="/_app/immutable/assets/time.svelte_svelte_type_style_lang-61ea3f89.css">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/_...entity_.svelte-d69f21a9.css">
	<link rel="modulepreload" href="/_app/immutable/start-ce704036.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-7416df8b.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/singletons-d1fb5791.js">
	<link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-0c722760.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/time.svelte_svelte_type_style_lang-2ab901cd.js">
	<link rel="modulepreload" href="/_app/immutable/pages/_...entity_.svelte-8f381217.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/tags-06b98af7.js">
  </head>
  <body>
    <div>




<nav><ul><li><a sveltekit:prefetch href="/">葉月夜堂</a>
      </li><li><a sveltekit:prefetch href="/about">about</a>
      </li></ul></nav>



<div class="nav-background svelte-6mvvsp isHeaderInView" style=""></div>

<main><article data-kind="note" class="svelte-6mvvsp"><header class="svelte-6mvvsp"><h1 class="svelte-6mvvsp">jQueryの<wbr>mapは<wbr>勝手に<wbr>flattenする</h1>

      

      <section class="meta svelte-6mvvsp"><p class="svelte-6mvvsp"><time title="5 年半前" class="svelte-5ni4x2">Tue Dec 27 2016 21:08:02 GMT+0000 (Coordinated Universal Time)</time></p>

        <p class="svelte-6mvvsp"><a href="https://github.com/kissge/yo.eki.do/commits/master/notes/jquery-map-flatten.md" title="Sun Apr 17 2022 12:08:43 GMT+0000 (Coordinated Universal Time)" class="svelte-6mvvsp">最終更新：2 か月半前</a></p></section>

      

      

      <section class="header-image svelte-6mvvsp" style=""></section></header>

    <section class="body svelte-6mvvsp"><!-- HTML_TAG_START --><!--more-->

<p>jQueryの <code>map</code> は勝手に中身をflattenする。つまり、</p>
<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>a<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>b<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>a<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>b<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>c<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<p>というような構造があったときに</p>
<pre><code class="language-js">$(<span class="hljs-string">&#x27;ul&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">index, element</span>) =&gt;</span> $(element).<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;li&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">index, element</span>) =&gt;</span> $(element).<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toArray</span>())
==&gt; [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>] <span class="hljs-comment">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>
</code></pre>
<p>と勝手に入れ子になった配列がひとつの配列に変換されてしまう。
一応これはバグではなく仕様のようだ（<a href="https://bugs.jquery.com/ticket/10541">参考</a>）。
どう対応するのがいいのかよく分からないが……dirty hackとしては戻り値をさらに配列でラップすると一応欲しいものは得られる。</p>
<pre><code class="language-js">$(<span class="hljs-string">&#x27;ul&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">index, element</span>) =&gt;</span> [$(element).<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;li&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">index, element</span>) =&gt;</span> $(element).<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toArray</span>()])
==&gt; [[<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>], [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>]]
</code></pre>
<p>うーん、やだなあ。
同じ挙動は <code>jQuery.map</code> でも見られる。ただし引数の順番が逆だけど。</p>
<pre><code class="language-js">$.<span class="hljs-title function_">map</span>($(<span class="hljs-string">&#x27;ul&#x27;</span>), <span class="hljs-function">(<span class="hljs-params">element, index</span>) =&gt;</span> $.<span class="hljs-title function_">map</span>($(element).<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;li&#x27;</span>), <span class="hljs-function">(<span class="hljs-params">element, index</span>) =&gt;</span> $(element).<span class="hljs-title function_">text</span>()))
==&gt; [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>] <span class="hljs-comment">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]</span>

$.<span class="hljs-title function_">map</span>($(<span class="hljs-string">&#x27;ul&#x27;</span>), <span class="hljs-function">(<span class="hljs-params">element, index</span>) =&gt;</span> [$.<span class="hljs-title function_">map</span>($(element).<span class="hljs-title function_">find</span>(<span class="hljs-string">&#x27;li&#x27;</span>), <span class="hljs-function">(<span class="hljs-params">element, index</span>) =&gt;</span> $(element).<span class="hljs-title function_">text</span>())])
==&gt; [[<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>], [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>]]
</code></pre>
<p>やめてほしい。</p>
<!-- HTML_TAG_END --></section>

    

    <section class="mentions svelte-19gm1ik"><section class="reaction svelte-19gm1ik"><a href="https://twitter.com/intent/tweet?url=" class="svelte-19gm1ik" style="background-image: url(/_app/immutable/assets/message-circle-c0b45d48.svg); color: #3579d1;"><small class="svelte-19gm1ik">Twitterで</small>
        <span class="svelte-19gm1ik">コメントする</span></a></section>

  <h1 class="svelte-19gm1ik">Mentions</h1>
  <ol reversed class="svelte-19gm1ik loading"></ol>
</section></article>
</main>

<footer>Built with <a href="https://github.com/kissge/monolog">monolog</a>
</footer>


		<script type="module" data-sveltekit-hydrate="1yaiwmj">
		import { start } from "/_app/immutable/start-ce704036.js";
		start({
			target: document.querySelector('[data-sveltekit-hydrate="1yaiwmj"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "always",
			hydrate: {
				status: 200,
				error: null,
				nodes: [0, 2],
				params: {entity:"notes\u002Fjquery-map-flatten\u002F"},
				routeId: "[...entity]"
			}
		});
	</script><script type="application/json" sveltekit:data-type="props">{"entity":{"name":"jQueryのmapは勝手にflattenする","nameSegmented":["jQueryの","mapは","勝手に","flattenする"],"kind":"note","urlPath":"/notes/jquery-map-flatten","historyURL":"https://github.com/kissge/yo.eki.do/commits/master/notes/jquery-map-flatten.md","lastModified":"2022-04-17T12:08:43.000Z","attributes":{"from":"wordpress","title":"jQueryのmapは勝手にflattenする","date":"2016-12-27T21:08:02.000Z"},"tags":[],"body":"\u003C!--more-->\n\n\u003Cp>jQueryの \u003Ccode>map\u003C/code> は勝手に中身をflattenする。つまり、\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-html\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">ul\u003C/span>&gt;\u003C/span>\n    \u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>a\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>\n    \u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>b\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>\n\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">ul\u003C/span>&gt;\u003C/span>\n\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">ul\u003C/span>&gt;\u003C/span>\n    \u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>a\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>\n    \u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>b\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>\n    \u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>c\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">li\u003C/span>&gt;\u003C/span>\n\u003Cspan class=\"hljs-tag\">&lt;/\u003Cspan class=\"hljs-name\">ul\u003C/span>&gt;\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>というような構造があったときに\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-js\">$(\u003Cspan class=\"hljs-string\">&#x27;ul&#x27;\u003C/span>).\u003Cspan class=\"hljs-title function_\">map\u003C/span>(\u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">index, element\u003C/span>) =&gt;\u003C/span> $(element).\u003Cspan class=\"hljs-title function_\">find\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;li&#x27;\u003C/span>).\u003Cspan class=\"hljs-title function_\">map\u003C/span>(\u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">index, element\u003C/span>) =&gt;\u003C/span> $(element).\u003Cspan class=\"hljs-title function_\">text\u003C/span>()).\u003Cspan class=\"hljs-title function_\">toArray\u003C/span>())\n==&gt; [\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;c&quot;\u003C/span>] \u003Cspan class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>と勝手に入れ子になった配列がひとつの配列に変換されてしまう。\n一応これはバグではなく仕様のようだ（\u003Ca href=\"https://bugs.jquery.com/ticket/10541\">参考\u003C/a>）。\nどう対応するのがいいのかよく分からないが……dirty hackとしては戻り値をさらに配列でラップすると一応欲しいものは得られる。\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-js\">$(\u003Cspan class=\"hljs-string\">&#x27;ul&#x27;\u003C/span>).\u003Cspan class=\"hljs-title function_\">map\u003C/span>(\u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">index, element\u003C/span>) =&gt;\u003C/span> [$(element).\u003Cspan class=\"hljs-title function_\">find\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;li&#x27;\u003C/span>).\u003Cspan class=\"hljs-title function_\">map\u003C/span>(\u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">index, element\u003C/span>) =&gt;\u003C/span> $(element).\u003Cspan class=\"hljs-title function_\">text\u003C/span>()).\u003Cspan class=\"hljs-title function_\">toArray\u003C/span>()])\n==&gt; [[\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>], [\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;c&quot;\u003C/span>]]\n\u003C/code>\u003C/pre>\n\u003Cp>うーん、やだなあ。\n同じ挙動は \u003Ccode>jQuery.map\u003C/code> でも見られる。ただし引数の順番が逆だけど。\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-js\">$.\u003Cspan class=\"hljs-title function_\">map\u003C/span>($(\u003Cspan class=\"hljs-string\">&#x27;ul&#x27;\u003C/span>), \u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">element, index\u003C/span>) =&gt;\u003C/span> $.\u003Cspan class=\"hljs-title function_\">map\u003C/span>($(element).\u003Cspan class=\"hljs-title function_\">find\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;li&#x27;\u003C/span>), \u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">element, index\u003C/span>) =&gt;\u003C/span> $(element).\u003Cspan class=\"hljs-title function_\">text\u003C/span>()))\n==&gt; [\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;c&quot;\u003C/span>] \u003Cspan class=\"hljs-comment\">// not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]]\u003C/span>\n\n$.\u003Cspan class=\"hljs-title function_\">map\u003C/span>($(\u003Cspan class=\"hljs-string\">&#x27;ul&#x27;\u003C/span>), \u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">element, index\u003C/span>) =&gt;\u003C/span> [$.\u003Cspan class=\"hljs-title function_\">map\u003C/span>($(element).\u003Cspan class=\"hljs-title function_\">find\u003C/span>(\u003Cspan class=\"hljs-string\">&#x27;li&#x27;\u003C/span>), \u003Cspan class=\"hljs-function\">(\u003Cspan class=\"hljs-params\">element, index\u003C/span>) =&gt;\u003C/span> $(element).\u003Cspan class=\"hljs-title function_\">text\u003C/span>())])\n==&gt; [[\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>], [\u003Cspan class=\"hljs-string\">&quot;a&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;b&quot;\u003C/span>, \u003Cspan class=\"hljs-string\">&quot;c&quot;\u003C/span>]]\n\u003C/code>\u003C/pre>\n\u003Cp>やめてほしい。\u003C/p>\n","headline":"jQueryの map は勝手に中身をflattenする。つまり、&lt;ul&gt;    &lt;li&gt;a&lt;/li&gt;    &lt;li&gt;b&lt;/li&gt;&lt;/ul&gt;&lt;ul&gt;    &lt;li&gt;a&lt;/li&gt;    &lt;li&gt;b&lt;/li&gt;    &lt;li&gt;c&lt;/li&gt;&lt;/ul&gt;というような構造があったときに$(&#x27;ul&#x27;).map((index, element) =&gt; $(element).find(&#x27;li&#x27;).map((index, element) =&gt; $(element).text()).toArray())==&gt; [&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;] // not [[&quot;a&quot;, &quot;b&quot;], [&quot;a&quot;, &quot;b&quot;, &quot","links":{"to":{"urlPath":"/notes/jquery-map-flatten","entities":[]},"from":{"urlPath":"/notes/jquery-map-flatten","entities":[]},"kind":{"urlPath":"/notes/jquery-map-flatten","entities":[]}}}}</script></div>
  </body>
</html>
