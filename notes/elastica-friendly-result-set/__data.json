{"type":"data","nodes":[null,{"type":"data","data":[{"entity":1},{"name":2,"nameSegmented":3,"kind":11,"urlPath":12,"historyURL":13,"lastModified":14,"attributes":15,"tags":18,"body":19,"headline":20,"links":21,"isEmpty":64},"Elasticaの戻り値をいい感じにラップするライブラリを書いた",[4,5,6,7,8,9,10],"Elasticaの","戻り値を","いい","感じに","ラップする","ライブラリを","書いた","note","/notes/elastica-friendly-result-set","https://github.com/kissge/yo.eki.do/commits/master/notes/elastica-friendly-result-set.md",["Date","2022-04-17T12:08:43.000Z"],{"from":16,"title":2,"date":17},"wordpress",["Date","2016-07-27T05:34:31.000Z"],[],"\u003Cp>PHPでElasticSearchをあつかうときの定番\u003Ca href=\"/mono/%E3%83%A9%E3%82%A4%E3%83%96\" class=\"monolog-link\"  title=\"ライブ\">ライブ\u003C/a>ラリに\u003Ca href=\"https://github.com/ruflin/Elastica\">Elastica\u003C/a>というものがある。Symfonyで扱うときはこれをさらにラップした\u003Ca href=\"https://github.com/FriendsOfSymfony/FOSElasticaBundle\">FOSElasticaBundle\u003C/a>を使うとよい。\u003C/p>\n\u003Cp>Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。\u003C/p>\n\u003C!--more-->\n\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span> = \u003Cspan class=\"hljs-variable\">$index\u003C/span>-&gt;\u003Cspan class=\"hljs-title function_ invoke__\">search\u003C/span>(\u003Cspan class=\"hljs-variable\">$query\u003C/span>)-&gt;\u003Cspan class=\"hljs-title function_ invoke__\">getAggregations\u003C/span>()\n\u003C/code>\u003C/pre>\n\u003Cp>こんな感じで結果を取るとすると\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">[\n    \u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span> =&gt; [\n        \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n            [\n                \u003Cspan class=\"hljs-string\">&#x27;key_as_string&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;2016-05-31T15:00:00.000Z&#x27;\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1464706800000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span> =&gt; [\n                    \u003Cspan class=\"hljs-string\">&#x27;doc_count_error_upper_bound&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;sum_other_doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;Emacs&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">800\u003C/span>,\n                        ],\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;nano&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">200\u003C/span>,\n                        ],\n                    ],\n                ],\n            ],\n            [\n                \u003Cspan class=\"hljs-string\">&#x27;key_as_string&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;2016-06-30T15:00:00.000Z&#x27;\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1467298800000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">2000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span> =&gt; [\n                    \u003Cspan class=\"hljs-string\">&#x27;doc_count_error_upper_bound&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;sum_other_doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;SublimeText&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1800\u003C/span>,\n                        ],\n                    ],\n                ],\n            ],\n        ],\n    ],\n]\n\u003C/code>\u003C/pre>\n\u003Cp>こんな感じで返ってきたりするので\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span>[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>]\n\u003C/code>\u003C/pre>\n\u003Cp>とかやって欲しいデータを取る。ちょっと指が疲れて微妙なのでこの辺をいい感じにラップする\u003Ca href=\"/mono/%E3%83%A9%E3%82%A4%E3%83%96\" class=\"monolog-link\"  title=\"ライブ\">ライブ\u003C/a>ラリ\u003Ca href=\"https://github.com/kissge/ElasticaFriendlyResultSet\">ElasticaFriendlyResultSet\u003C/a>を書いた。\u003C/p>\n\u003Cx-script src=\"https://cdn.jsdelivr.net/github-cards/latest/widget.js\">\n\u003Cdiv class=\"github-card\" data-github=\"kissge/ElasticaFriendlyResultSet\" data-width=\"400\" data-height=\"296\" data-theme=\"medium\">\u003C/div>\n\u003C/x-script>\n\n\u003Cp>これを使うと\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span>-&gt;interval-&gt;editor-&gt;doc_count\n\u003C/code>\u003C/pre>\n\u003Cp>となる。\u003C/p>\n\u003Cp>……あんまり変わってないじゃん！と思うかもしれないが、これをtwigから呼ぶと\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-variable\">{{ result[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>] }}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>が\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-variable\">{{ result.interval.editor.doc_count }}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>になったり\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> interval \u003Cspan class=\"hljs-keyword\">in\u003C/span> result[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>] \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> editor \u003Cspan class=\"hljs-keyword\">in\u003C/span> interval[\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>] \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n        \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor[\u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span>] }}\u003C/span>\u003Cspan class=\"language-xml\">: \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor[\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>] }}\u003C/span>\u003Cspan class=\"language-xml\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">br\u003C/span> /&gt;\u003C/span>\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n\u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>が\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> interval \u003Cspan class=\"hljs-keyword\">in\u003C/span> result.interval \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> key, editor \u003Cspan class=\"hljs-keyword\">in\u003C/span> interval.editor \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n        \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ key }}\u003C/span>\u003Cspan class=\"language-xml\">: \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor.doc_count }}\u003C/span>\u003Cspan class=\"language-xml\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">br\u003C/span> /&gt;\u003C/span>\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n\u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>になったら嬉しくないですか？\u003C/p>\n\u003Cp>ついでに今回練習を兼ねて\u003Ca href=\"https://travis-ci.org/kissge/ElasticaFriendlyResultSet\">Travis CI\u003C/a>での自動テスト、\u003Ca href=\"https://coveralls.io/github/kissge/ElasticaFriendlyResultSet\">Coveralls\u003C/a>でのカバレッジレポートとかいろいろ遊んだ。なんか表示がぶっ壊れてるけど。テスト初心者だけど、カバレッジ可視化はモチベーションにつながって良いことだと思う。passing &amp; 100%のGitHubドヤ顔緑バッジ……もなんか出てないけど（GitHubがキャッシュするから？）。\u003C/p>\n\u003Cfigure>\u003Cimg src=\"/images/uploads/2016/07/Screenshot-2016-07-27-05.27.17.png\" alt=\"図\">\u003C/figure>\u003Cp>ついでに\u003Ca href=\"https://packagist.org\">Packagist\u003C/a>にも\u003Ca href=\"https://packagist.org/packages/kissge/elastica-friendly-result-set\">登録した\u003C/a>ので\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">composer require kissge/elastica-friendly-result-set\n\u003C/code>\u003C/pre>\n\u003Cp>だけでインストールできるようになった。登録は一瞬で済んだ。\u003C/p>\n","PHPでElasticSearchをあつかうときの定番ライブラリにElasticaというものがある。Symfonyで扱うときはこれをさらにラップしたFOSElasticaBundleを使うとよい。Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。$result = $index-&gt;search($query)-&gt;getAggregations()こんな感じで結果を取るとすると[    &#x27;interval&#x27; =&gt; [        &#x27;buckets&#x27; =&gt; [            [                &#x27;key_as_string&#x27; =&gt; &#x27;2016-05-31T15:00:00.000Z&#x27;,                 &#x27;key&#x27; =&gt; 1464706800000,                 &#x27;doc_count&#x27; =&gt; 1000,   ",{"to":22,"one_hop_ライブ":31},{"urlPath":12,"entities":23},[24],{"name":25,"nameSegmented":26,"kind":27,"urlPath":28,"tags":29,"isEmpty":30},"ライブ",[25],"kind","/mono/%E3%83%A9%E3%82%A4%E3%83%96",[],true,{"urlPath":28,"entities":32},[33,65,79,93],{"name":34,"nameSegmented":35,"kind":25,"urlPath":41,"historyURL":42,"lastModified":43,"attributes":44,"tags":52,"isEmpty":64},"♡十束おとは生誕祭♡おとはす最後のお願い♡2大祭り♡",[36,37,38,39,40],"♡十束おとは","生誕祭♡おとは","す最後の","お願い","♡2大祭り♡","/mono/%E2%99%A1%E5%8D%81%E6%9D%9F%E3%81%8A%E3%81%A8%E3%81%AF%E7%94%9F%E8%AA%95%E7%A5%AD%E2%99%A1%E3%81%8A%E3%81%A8%E3%81%AF%E3%81%99%E6%9C%80%E5%BE%8C%E3%81%AE%E3%81%8A%E9%A1%98%E3%81%84%E2%99%A12%E5%A4%A7%E7%A5%AD%E3%82%8A%E2%99%A1","https://github.com/kissge/yo.eki.do/commits/master/mono/ライブ/♡十束おとは生誕祭♡おとはす最後のお願い♡2大祭り♡.md",["Date","2022-09-18T05:05:39.000Z"],{"date":45,"location":46,"creator":47,"tags":50},"2022-09-11","Shibuya O-EAST",[48,49],"十束おとは","フィロソフィーのダンス",[51],"みたもの",[53,56,59,62],{"name":51,"kind":54,"urlPath":55},"tag","/mono/%E3%81%BF%E3%81%9F%E3%82%82%E3%81%AE",{"name":46,"kind":57,"urlPath":58},"location","/mono/Shibuya%20O-EAST",{"name":48,"kind":60,"urlPath":61},"creator","/mono/%E5%8D%81%E6%9D%9F%E3%81%8A%E3%81%A8%E3%81%AF",{"name":49,"kind":60,"urlPath":63},"/mono/%E3%83%95%E3%82%A3%E3%83%AD%E3%82%BD%E3%83%95%E3%82%A3%E3%83%BC%E3%81%AE%E3%83%80%E3%83%B3%E3%82%B9",false,{"name":66,"nameSegmented":67,"kind":68,"urlPath":69,"historyURL":70,"lastModified":71,"attributes":72,"tags":76,"isEmpty":64},"サカナクション",[66],"ミュージシャン","/mono/%E3%82%B5%E3%82%AB%E3%83%8A%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3","https://github.com/kissge/yo.eki.do/commits/master/mono/ミュージシャン/サカナクション.md",["Date","2022-06-11T11:33:32.000Z"],{"definition":73,"tags":74},"良い違和感を体現する音楽性の日本のロックバンド",[75],"推し",[77],{"name":75,"kind":54,"urlPath":78},"/mono/%E6%8E%A8%E3%81%97",{"name":80,"nameSegmented":81,"kind":11,"urlPath":82,"historyURL":83,"lastModified":84,"attributes":85,"tags":90,"isEmpty":64},"How do Japanese type?",[80],"/notes/how-do-japanese-type","https://github.com/kissge/yo.eki.do/commits/master/notes/how-do-japanese-type.md",["Date","2022-06-11T11:32:30.000Z"],{"title":80,"date":86,"lang":87,"tags":88},["Date","2022-05-29T01:00:00.000Z"],"en",[89],"日本語",[91],{"name":89,"kind":54,"urlPath":92},"/mono/%E6%97%A5%E6%9C%AC%E8%AA%9E",{"name":94,"nameSegmented":95,"kind":25,"urlPath":96,"historyURL":97,"lastModified":98,"attributes":99,"tags":103,"isEmpty":64},"SAKANAQUARIUM 2018 魚図鑑ゼミナール",[94],"/mono/SAKANAQUARIUM%202018%20%E9%AD%9A%E5%9B%B3%E9%91%91%E3%82%BC%E3%83%9F%E3%83%8A%E3%83%BC%E3%83%AB","https://github.com/kissge/yo.eki.do/commits/master/mono/ライブ/SAKANAQUARIUM 2018 魚図鑑ゼミナール.md",["Date","2022-06-11T11:33:32.000Z"],{"date":100,"location":101,"creator":66,"tags":102},"2018-07-10","Zepp Tokyo",[51],[104,105,107],{"name":51,"kind":54,"urlPath":55},{"name":101,"kind":57,"urlPath":106},"/mono/Zepp%20Tokyo",{"name":66,"kind":60,"urlPath":69}],"uses":{"url":1}}]}
