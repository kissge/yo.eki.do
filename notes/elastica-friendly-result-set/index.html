<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <link href=/global.css rel=preload as=style onload="this.onload=null;this.rel='stylesheet'"> <link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css rel=preload as=style onload="this.onload=null;this.rel='stylesheet'"> <link href=/manifest.json rel=manifest crossorigin=use-credentials> <link href=/images/favicon.svg rel=icon type=image/svg+xml> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{from:"wordpress",title:"Elasticaの戻り値をいい感じにラップするライブラリを書いた",date:"2016-07-27T05:34:31.000Z",type:"notes",slug:"elastica-friendly-result-set",html:"\u003Cp\u003EPHPでElasticSearchをあつかうときの定番ライブラリに\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fruflin\u002FElastica\"\u003EElastica\u003C\u002Fa\u003Eというものがある。\nSymfonyで扱うときはこれをさらにラップした\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FFriendsOfSymfony\u002FFOSElasticaBundle\"\u003EFOSElasticaBundle\u003C\u002Fa\u003Eを使うとよい。\u003C\u002Fp\u003E\n\u003Cp\u003EElasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。\u003C\u002Fp\u003E\n\u003C!--more--\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-php\"\u003E\u003Cspan class=\"hljs-variable\"\u003E$result\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-variable\"\u003E$index\u003C\u002Fspan\u003E-&gt;\u003Cspan class=\"hljs-title function_ invoke__\"\u003Esearch\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-variable\"\u003E$query\u003C\u002Fspan\u003E)-&gt;\u003Cspan class=\"hljs-title function_ invoke__\"\u003EgetAggregations\u003C\u002Fspan\u003E()\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eこんな感じで結果を取るとすると\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-php\"\u003E[\n    \u003Cspan class=\"hljs-string\"\u003E&#x27;interval&#x27;\u003C\u002Fspan\u003E =&gt; [\n        \u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E =&gt; [\n            [\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;key_as_string&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-string\"\u003E&#x27;2016-05-31T15:00:00.000Z&#x27;\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E1464706800000\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E1000\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;editor&#x27;\u003C\u002Fspan\u003E =&gt; [\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count_error_upper_bound&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E,\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;sum_other_doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E,\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-string\"\u003E&#x27;Emacs&#x27;\u003C\u002Fspan\u003E,\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E800\u003C\u002Fspan\u003E,\n                        ],\n                        [\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-string\"\u003E&#x27;nano&#x27;\u003C\u002Fspan\u003E,\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E200\u003C\u002Fspan\u003E,\n                        ],\n                    ],\n                ],\n            ],\n            [\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;key_as_string&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-string\"\u003E&#x27;2016-06-30T15:00:00.000Z&#x27;\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E1467298800000\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E2000\u003C\u002Fspan\u003E,\n                \u003Cspan class=\"hljs-string\"\u003E&#x27;editor&#x27;\u003C\u002Fspan\u003E =&gt; [\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count_error_upper_bound&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E,\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;sum_other_doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E,\n                    \u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-string\"\u003E&#x27;SublimeText&#x27;\u003C\u002Fspan\u003E,\n                            \u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E =&gt; \u003Cspan class=\"hljs-number\"\u003E1800\u003C\u002Fspan\u003E,\n                        ],\n                    ],\n                ],\n            ],\n        ],\n    ],\n]\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eこんな感じで返ってきたりするので\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-php\"\u003E\u003Cspan class=\"hljs-variable\"\u003E$result\u003C\u002Fspan\u003E[\u003Cspan class=\"hljs-string\"\u003E&#x27;interval&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;editor&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E]\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eとかやって欲しいデータを取る。\nちょっと指が疲れて微妙なのでこの辺をいい感じにラップするライブラリ\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkissge\u002FElasticaFriendlyResultSet\"\u003EElasticaFriendlyResultSet\u003C\u002Fa\u003Eを書いた。\u003C\u002Fp\u003E\n\u003Cx-script src=\"https:\u002F\u002Fcdn.jsdelivr.net\u002Fgithub-cards\u002Flatest\u002Fwidget.js\"\u003E\n\u003Cdiv class=\"github-card\" data-github=\"kissge\u002FElasticaFriendlyResultSet\" data-width=\"400\" data-height=\"296\" data-theme=\"medium\"\u003E\u003C\u002Fdiv\u003E\n\u003C\u002Fx-script\u003E\n\u003Cp\u003Eこれを使うと\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-php\"\u003E\u003Cspan class=\"hljs-variable\"\u003E$result\u003C\u002Fspan\u003E-&gt;interval-&gt;editor-&gt;doc_count\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eとなる。\u003C\u002Fp\u003E\n\u003Cp\u003E……あんまり変わってないじゃん！と思うかもしれないが、これをtwigから呼ぶと\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-twig\"\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ result[\u003Cspan class=\"hljs-string\"\u003E&#x27;interval&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;editor&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E] }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eが\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-twig\"\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ result.interval.editor.doc_count }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eになったり\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-twig\"\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Efor\u003C\u002Fspan\u003E interval \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E result[\u003Cspan class=\"hljs-string\"\u003E&#x27;interval&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E] \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Efor\u003C\u002Fspan\u003E editor \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E interval[\u003Cspan class=\"hljs-string\"\u003E&#x27;editor&#x27;\u003C\u002Fspan\u003E][\u003Cspan class=\"hljs-string\"\u003E&#x27;buckets&#x27;\u003C\u002Fspan\u003E] \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ editor[\u003Cspan class=\"hljs-string\"\u003E&#x27;key&#x27;\u003C\u002Fspan\u003E] }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E: \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ editor[\u003Cspan class=\"hljs-string\"\u003E&#x27;doc_count&#x27;\u003C\u002Fspan\u003E] }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\u003Cspan class=\"hljs-tag\"\u003E&lt;\u003Cspan class=\"hljs-name\"\u003Ebr\u003C\u002Fspan\u003E \u002F&gt;\u003C\u002Fspan\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Eendfor\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Eendfor\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eが\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-twig\"\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Efor\u003C\u002Fspan\u003E interval \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E result.interval \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Efor\u003C\u002Fspan\u003E key, editor \u003Cspan class=\"hljs-keyword\"\u003Ein\u003C\u002Fspan\u003E interval.editor \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ key }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E: \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-variable\"\u003E{{ editor.doc_count }}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\u003Cspan class=\"hljs-tag\"\u003E&lt;\u003Cspan class=\"hljs-name\"\u003Ebr\u003C\u002Fspan\u003E \u002F&gt;\u003C\u002Fspan\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Eendfor\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-template-tag\"\u003E{%\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-name\"\u003Eendfor\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-template-tag\"\u003E%}\u003C\u002Fspan\u003E\u003Cspan class=\"language-xml\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eになったら嬉しくないですか？\u003C\u002Fp\u003E\n\u003Cp\u003Eついでに今回練習を兼ねて\u003Ca href=\"https:\u002F\u002Ftravis-ci.org\u002Fkissge\u002FElasticaFriendlyResultSet\"\u003ETravis CI\u003C\u002Fa\u003Eでの自動テスト、\u003Ca href=\"https:\u002F\u002Fcoveralls.io\u002Fgithub\u002Fkissge\u002FElasticaFriendlyResultSet\"\u003ECoveralls\u003C\u002Fa\u003Eでのカバレッジレポートとかいろいろ遊んだ。なんか表示がぶっ壊れてるけど。\nテスト初心者だけど、カバレッジ可視化はモチベーションにつながって良いことだと思う。\npassing &amp; 100%のGitHubドヤ顔緑バッジ……もなんか出てないけど（GitHubがキャッシュするから？）。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg src=\"\u002Fimages\u002Fuploads\u002F2016\u002F07\u002FScreenshot-2016-07-27-05.27.17.png\" alt=\"図\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Eついでに\u003Ca href=\"https:\u002F\u002Fpackagist.org\"\u003EPackagist\u003C\u002Fa\u003Eにも\u003Ca href=\"https:\u002F\u002Fpackagist.org\u002Fpackages\u002Fkissge\u002Felastica-friendly-result-set\"\u003E登録した\u003C\u002Fa\u003Eので\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-sh\"\u003Ecomposer require kissge\u002Felastica-friendly-result-set\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eだけでインストールできるようになった。登録は一瞬で済んだ。\u003C\u002Fp\u003E\n",headline:"PHPでElasticSearchをあつかうときの定番ライブラリにElasticaというものがある。Symfonyで扱うときはこれをさらにラップしたFOSElasticaBundleを使うとよい。El"},historyURL:"https:\u002F\u002Fgithub.com\u002Fkissge\u002Fyo.eki.do\u002Fcommits\u002Fmaster\u002Fnotes\u002Felastica-friendly-result-set.md"}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.be60621d.js"}catch(e){main="/client/legacy/client.26357dcb.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.5.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <link href=client/client-4fbf6b2c.css rel=stylesheet><link href=client/_slug_-3143690c.css rel=stylesheet> <title>Elasticaの戻り値をいい感じにラップするライブラリを書いた - 2016-07-27 | 葉月夜堂</title><link href=https://twitter.com/p_km rel=me data-svelte=svelte-119a9vg> <link href=https://webmention.io/yo.eki.do/webmention rel=webmention data-svelte=svelte-119a9vg> <link href=https://webmention.io/yo.eki.do/xmlrpc rel=pingback data-svelte=svelte-119a9vg><meta content=article data-svelte=svelte-zqyuod property=og:type><meta content="Elasticaの戻り値をいい感じにラップするライブラリを書いた - 2016-07-27 | 葉月夜堂" data-svelte=svelte-zqyuod property=og:title><meta content=PHPでElasticSearchをあつかうときの定番ライブラリにElasticaというものがある。Symfonyで扱うときはこれをさらにラップしたFOSElasticaBundleを使うとよい。El data-svelte=svelte-zqyuod property=og:description><meta content=葉月夜堂 data-svelte=svelte-zqyuod property=og:site_name><meta content=https://yo.eki.do/images/default.png data-svelte=svelte-zqyuod property=og:image> <link href=/client/client.be60621d.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-4fbf6b2c.css rel=preload as=style><link href=/client/_slug_.7b298a4e.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/utility.16d055df.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.803b7e80.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/_slug_-3143690c.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-12an8ua><ul class=svelte-12an8ua><li class=svelte-12an8ua><a href=/ class=svelte-12an8ua rel=prefetch>articles</a></li> <li class=svelte-12an8ua><a href=/about class=svelte-12an8ua rel=prefetch>about</a></ul> </nav> <main class=svelte-gph4rb> <header class=svelte-odkuvz><div class="svelte-odkuvz img-header" style=""></div> <h1 class=svelte-odkuvz>Elasticaの戻り値をいい感じにラップするライブラリを書いた</h1> <time class=svelte-odkuvz title=5 年半前>2016-07-27<span class=date-weak>T</span>14:34:31<span class=date-weak>+09:00</span></time> <div class=tags></div> <p class="svelte-odkuvz history"><a href=https://github.com/kissge/yo.eki.do/commits/master/notes/elastica-friendly-result-set.md>更新履歴</a></header> <h1 class="svelte-odkuvz floating-header">Elasticaの戻り値をいい感じにラップするライブラリを書いた</h1> <div class="svelte-odkuvz callout">この記事は以前別のところにあったものを移してきたものです。完璧に移植できておらず、表示が崩れているかもしれません。 </div> <div class="svelte-odkuvz content"><p>PHPでElasticSearchをあつかうときの定番ライブラリに<a href=https://github.com/ruflin/Elastica>Elastica</a>というものがある。 Symfonyで扱うときはこれをさらにラップした<a href=https://github.com/FriendsOfSymfony/FOSElasticaBundle>FOSElasticaBundle</a>を使うとよい。</p> <p>Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。</p> <pre><code class="hljs language-php"><span class=hljs-variable>$result</span> = <span class=hljs-variable>$index</span>-><span class="function_ hljs-title invoke__">search</span>(<span class=hljs-variable>$query</span>)-><span class="function_ hljs-title invoke__">getAggregations</span>()
</code></pre> <p>こんな感じで結果を取るとすると</p> <pre><code class="hljs language-php">[
    <span class=hljs-string>'interval'</span> => [
        <span class=hljs-string>'buckets'</span> => [
            [
                <span class=hljs-string>'key_as_string'</span> => <span class=hljs-string>'2016-05-31T15:00:00.000Z'</span>,
                <span class=hljs-string>'key'</span> => <span class=hljs-number>1464706800000</span>,
                <span class=hljs-string>'doc_count'</span> => <span class=hljs-number>1000</span>,
                <span class=hljs-string>'editor'</span> => [
                    <span class=hljs-string>'doc_count_error_upper_bound'</span> => <span class=hljs-number>0</span>,
                    <span class=hljs-string>'sum_other_doc_count'</span> => <span class=hljs-number>0</span>,
                    <span class=hljs-string>'buckets'</span> => [
                        [
                            <span class=hljs-string>'key'</span> => <span class=hljs-string>'Emacs'</span>,
                            <span class=hljs-string>'doc_count'</span> => <span class=hljs-number>800</span>,
                        ],
                        [
                            <span class=hljs-string>'key'</span> => <span class=hljs-string>'nano'</span>,
                            <span class=hljs-string>'doc_count'</span> => <span class=hljs-number>200</span>,
                        ],
                    ],
                ],
            ],
            [
                <span class=hljs-string>'key_as_string'</span> => <span class=hljs-string>'2016-06-30T15:00:00.000Z'</span>,
                <span class=hljs-string>'key'</span> => <span class=hljs-number>1467298800000</span>,
                <span class=hljs-string>'doc_count'</span> => <span class=hljs-number>2000</span>,
                <span class=hljs-string>'editor'</span> => [
                    <span class=hljs-string>'doc_count_error_upper_bound'</span> => <span class=hljs-number>0</span>,
                    <span class=hljs-string>'sum_other_doc_count'</span> => <span class=hljs-number>0</span>,
                    <span class=hljs-string>'buckets'</span> => [
                        [
                            <span class=hljs-string>'key'</span> => <span class=hljs-string>'SublimeText'</span>,
                            <span class=hljs-string>'doc_count'</span> => <span class=hljs-number>1800</span>,
                        ],
                    ],
                ],
            ],
        ],
    ],
]
</code></pre> <p>こんな感じで返ってきたりするので</p> <pre><code class="hljs language-php"><span class=hljs-variable>$result</span>[<span class=hljs-string>'interval'</span>][<span class=hljs-string>'buckets'</span>][<span class=hljs-string>'editor'</span>][<span class=hljs-string>'buckets'</span>][<span class=hljs-string>'doc_count'</span>]
</code></pre> <p>とかやって欲しいデータを取る。 ちょっと指が疲れて微妙なのでこの辺をいい感じにラップするライブラリ<a href=https://github.com/kissge/ElasticaFriendlyResultSet>ElasticaFriendlyResultSet</a>を書いた。</p> <x-script src=https://cdn.jsdelivr.net/github-cards/latest/widget.js> <div class=github-card data-github=kissge/ElasticaFriendlyResultSet data-height=296 data-theme=medium data-width=400></div> </x-script> <p>これを使うと</p> <pre><code class="hljs language-php"><span class=hljs-variable>$result</span>->interval->editor->doc_count
</code></pre> <p>となる。</p> <p>……あんまり変わってないじゃん！と思うかもしれないが、これをtwigから呼ぶと</p> <pre><code class="hljs language-twig"><span class=hljs-template-variable>{{ result[<span class=hljs-string>'interval'</span>][<span class=hljs-string>'buckets'</span>][<span class=hljs-string>'editor'</span>][<span class=hljs-string>'buckets'</span>][<span class=hljs-string>'doc_count'</span>] }}</span><span class=language-xml>
</span></code></pre> <p>が</p> <pre><code class="hljs language-twig"><span class=hljs-template-variable>{{ result.interval.editor.doc_count }}</span><span class=language-xml>
</span></code></pre> <p>になったり</p> <pre><code class="hljs language-twig"><span class=hljs-template-tag>{%</span> <span class=hljs-name>for</span> interval <span class=hljs-keyword>in</span> result[<span class=hljs-string>'interval'</span>][<span class=hljs-string>'buckets'</span>] <span class=hljs-template-tag>%}</span><span class=language-xml>
    </span><span class=hljs-template-tag>{%</span> <span class=hljs-name>for</span> editor <span class=hljs-keyword>in</span> interval[<span class=hljs-string>'editor'</span>][<span class=hljs-string>'buckets'</span>] <span class=hljs-template-tag>%}</span><span class=language-xml>
        </span><span class=hljs-template-variable>{{ editor[<span class=hljs-string>'key'</span>] }}</span><span class=language-xml>: </span><span class=hljs-template-variable>{{ editor[<span class=hljs-string>'doc_count'</span>] }}</span><span class=language-xml><span class=hljs-tag>&lt;<span class=hljs-name>br</span> /></span>
    </span><span class=hljs-template-tag>{%</span> <span class=hljs-name>endfor</span> <span class=hljs-template-tag>%}</span><span class=language-xml>
</span><span class=hljs-template-tag>{%</span> <span class=hljs-name>endfor</span> <span class=hljs-template-tag>%}</span><span class=language-xml>
</span></code></pre> <p>が</p> <pre><code class="hljs language-twig"><span class=hljs-template-tag>{%</span> <span class=hljs-name>for</span> interval <span class=hljs-keyword>in</span> result.interval <span class=hljs-template-tag>%}</span><span class=language-xml>
    </span><span class=hljs-template-tag>{%</span> <span class=hljs-name>for</span> key, editor <span class=hljs-keyword>in</span> interval.editor <span class=hljs-template-tag>%}</span><span class=language-xml>
        </span><span class=hljs-template-variable>{{ key }}</span><span class=language-xml>: </span><span class=hljs-template-variable>{{ editor.doc_count }}</span><span class=language-xml><span class=hljs-tag>&lt;<span class=hljs-name>br</span> /></span>
    </span><span class=hljs-template-tag>{%</span> <span class=hljs-name>endfor</span> <span class=hljs-template-tag>%}</span><span class=language-xml>
</span><span class=hljs-template-tag>{%</span> <span class=hljs-name>endfor</span> <span class=hljs-template-tag>%}</span><span class=language-xml>
</span></code></pre> <p>になったら嬉しくないですか？</p> <p>ついでに今回練習を兼ねて<a href=https://travis-ci.org/kissge/ElasticaFriendlyResultSet>Travis CI</a>での自動テスト、<a href=https://coveralls.io/github/kissge/ElasticaFriendlyResultSet>Coveralls</a>でのカバレッジレポートとかいろいろ遊んだ。なんか表示がぶっ壊れてるけど。 テスト初心者だけど、カバレッジ可視化はモチベーションにつながって良いことだと思う。 passing & 100%のGitHubドヤ顔緑バッジ……もなんか出てないけど（GitHubがキャッシュするから？）。</p> <p><img alt=図 src=/images/uploads/2016/07/Screenshot-2016-07-27-05.27.17.png></p> <p>ついでに<a href=https://packagist.org>Packagist</a>にも<a href=https://packagist.org/packages/kissge/elastica-friendly-result-set>登録した</a>ので</p> <pre><code class="hljs language-sh">composer require kissge/elastica-friendly-result-set
</code></pre> <p>だけでインストールできるようになった。登録は一瞬で済んだ。</p> </div> <x-script src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js async data-ad-client=ca-pub-5159408992513362></x-script> <section class="svelte-odkuvz mentions"><h1 class=svelte-odkuvz>Recent public mentions on Twitter</h1> <ol class=svelte-odkuvz reversed>Loading mentions...</ol> </section> </main></div> 