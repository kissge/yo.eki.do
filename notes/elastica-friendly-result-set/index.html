<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/images/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github.min.css" />
    <meta http-equiv="content-security-policy" content=""><title>Elasticaの戻り値をいい感じにラップするライブラリを書いた - 2016-07-27 | 葉月夜堂</title><link href="https://twitter.com/p_km" rel="me" data-svelte="svelte-10crdf0">
    <link rel="webmention" href="https://webmention.io/sveltekit-prerender/webmention" data-svelte="svelte-10crdf0">
    <link rel="pingback" href="https://webmention.io/sveltekit-prerender/xmlrpc" data-svelte="svelte-10crdf0"><meta property="og:type" content="article" data-svelte="svelte-6t30ru"><meta property="og:title" content="Elasticaの戻り値をいい感じにラップするライブラリを書いた - 2016-07-27 | 葉月夜堂" data-svelte="svelte-6t30ru"><meta property="og:description" content="PHPでElasticSearchをあつかうときの定番ライブラリにElasticaというものがある。Symfonyで扱うときはこれをさらにラップしたFOSElasticaBundleを使うとよい。Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。$result = $index-&amp;gt;search($query)-&amp;gt;getAggregations()こんな感じで結果を取るとすると[    &amp;#x27;interval&amp;#x27; =&amp;gt; [        &amp;#x27;buckets&amp;#x27; =&amp;gt; [            [                &amp;#x27;key_as_string&amp;#x27; =&amp;gt; &amp;#x27;2016-05-31T15:00:00.000Z&amp;#x27;,                 &amp;#x27;key&amp;#x27; =&amp;gt; 1464706800000,                 &amp;#x27;doc_count&amp;#x27; =&amp;gt; 1000,   " data-svelte="svelte-6t30ru"><meta property="og:site_name" content="葉月夜堂" data-svelte="svelte-6t30ru"><meta property="og:image" content="http://sveltekit-prerender/images/favicon.svg" data-svelte="svelte-6t30ru">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/__layout.svelte-f9a44566.css">
	<link rel="stylesheet" href="/_app/immutable/assets/time.svelte_svelte_type_style_lang-61ea3f89.css">
	<link rel="stylesheet" href="/_app/immutable/assets/pages/_...entity_.svelte-d69f21a9.css">
	<link rel="modulepreload" href="/_app/immutable/start-ce704036.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/index-7416df8b.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/singletons-d1fb5791.js">
	<link rel="modulepreload" href="/_app/immutable/pages/__layout.svelte-0c722760.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/time.svelte_svelte_type_style_lang-2ab901cd.js">
	<link rel="modulepreload" href="/_app/immutable/pages/_...entity_.svelte-8f381217.js">
	<link rel="modulepreload" href="/_app/immutable/chunks/tags-06b98af7.js">
  </head>
  <body>
    <div>




<nav><ul><li><a sveltekit:prefetch href="/">葉月夜堂</a>
      </li><li><a sveltekit:prefetch href="/about">about</a>
      </li></ul></nav>



<div class="nav-background svelte-6mvvsp isHeaderInView" style=""></div>

<main><article data-kind="note" class="svelte-6mvvsp"><header class="svelte-6mvvsp"><h1 class="svelte-6mvvsp">Elasticaの<wbr>戻り<wbr>値を<wbr>いい<wbr>感じに<wbr>ラップする<wbr>ライブラリを<wbr>書いた</h1>

      

      <section class="meta svelte-6mvvsp"><p class="svelte-6mvvsp"><time title="6 年前" class="svelte-5ni4x2">Wed Jul 27 2016 05:34:31 GMT+0000 (Coordinated Universal Time)</time></p>

        <p class="svelte-6mvvsp"><a href="https://github.com/kissge/yo.eki.do/commits/master/notes/elastica-friendly-result-set.md" title="Sun Apr 17 2022 12:08:43 GMT+0000 (Coordinated Universal Time)" class="svelte-6mvvsp">最終更新：2 か月半前</a></p></section>

      

      

      <section class="header-image svelte-6mvvsp" style=""></section></header>

    <section class="body svelte-6mvvsp"><!-- HTML_TAG_START --><p>PHPでElasticSearchをあつかうときの定番ライブラリに<a href="https://github.com/ruflin/Elastica">Elastica</a>というものがある。
Symfonyで扱うときはこれをさらにラップした<a href="https://github.com/FriendsOfSymfony/FOSElasticaBundle">FOSElasticaBundle</a>を使うとよい。</p>
<p>Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。</p>
<!--more-->

<pre><code class="language-php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$index</span>-&gt;<span class="hljs-title function_ invoke__">search</span>(<span class="hljs-variable">$query</span>)-&gt;<span class="hljs-title function_ invoke__">getAggregations</span>()
</code></pre>
<p>こんな感じで結果を取るとすると</p>
<pre><code class="language-php">[
    <span class="hljs-string">&#x27;interval&#x27;</span> =&gt; [
        <span class="hljs-string">&#x27;buckets&#x27;</span> =&gt; [
            [
                <span class="hljs-string">&#x27;key_as_string&#x27;</span> =&gt; <span class="hljs-string">&#x27;2016-05-31T15:00:00.000Z&#x27;</span>,
                <span class="hljs-string">&#x27;key&#x27;</span> =&gt; <span class="hljs-number">1464706800000</span>,
                <span class="hljs-string">&#x27;doc_count&#x27;</span> =&gt; <span class="hljs-number">1000</span>,
                <span class="hljs-string">&#x27;editor&#x27;</span> =&gt; [
                    <span class="hljs-string">&#x27;doc_count_error_upper_bound&#x27;</span> =&gt; <span class="hljs-number">0</span>,
                    <span class="hljs-string">&#x27;sum_other_doc_count&#x27;</span> =&gt; <span class="hljs-number">0</span>,
                    <span class="hljs-string">&#x27;buckets&#x27;</span> =&gt; [
                        [
                            <span class="hljs-string">&#x27;key&#x27;</span> =&gt; <span class="hljs-string">&#x27;Emacs&#x27;</span>,
                            <span class="hljs-string">&#x27;doc_count&#x27;</span> =&gt; <span class="hljs-number">800</span>,
                        ],
                        [
                            <span class="hljs-string">&#x27;key&#x27;</span> =&gt; <span class="hljs-string">&#x27;nano&#x27;</span>,
                            <span class="hljs-string">&#x27;doc_count&#x27;</span> =&gt; <span class="hljs-number">200</span>,
                        ],
                    ],
                ],
            ],
            [
                <span class="hljs-string">&#x27;key_as_string&#x27;</span> =&gt; <span class="hljs-string">&#x27;2016-06-30T15:00:00.000Z&#x27;</span>,
                <span class="hljs-string">&#x27;key&#x27;</span> =&gt; <span class="hljs-number">1467298800000</span>,
                <span class="hljs-string">&#x27;doc_count&#x27;</span> =&gt; <span class="hljs-number">2000</span>,
                <span class="hljs-string">&#x27;editor&#x27;</span> =&gt; [
                    <span class="hljs-string">&#x27;doc_count_error_upper_bound&#x27;</span> =&gt; <span class="hljs-number">0</span>,
                    <span class="hljs-string">&#x27;sum_other_doc_count&#x27;</span> =&gt; <span class="hljs-number">0</span>,
                    <span class="hljs-string">&#x27;buckets&#x27;</span> =&gt; [
                        [
                            <span class="hljs-string">&#x27;key&#x27;</span> =&gt; <span class="hljs-string">&#x27;SublimeText&#x27;</span>,
                            <span class="hljs-string">&#x27;doc_count&#x27;</span> =&gt; <span class="hljs-number">1800</span>,
                        ],
                    ],
                ],
            ],
        ],
    ],
]
</code></pre>
<p>こんな感じで返ってきたりするので</p>
<pre><code class="language-php"><span class="hljs-variable">$result</span>[<span class="hljs-string">&#x27;interval&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>][<span class="hljs-string">&#x27;editor&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>][<span class="hljs-string">&#x27;doc_count&#x27;</span>]
</code></pre>
<p>とかやって欲しいデータを取る。
ちょっと指が疲れて微妙なのでこの辺をいい感じにラップするライブラリ<a href="https://github.com/kissge/ElasticaFriendlyResultSet">ElasticaFriendlyResultSet</a>を書いた。</p>
<x-script src="https://cdn.jsdelivr.net/github-cards/latest/widget.js">
<div class="github-card" data-github="kissge/ElasticaFriendlyResultSet" data-width="400" data-height="296" data-theme="medium"></div>
</x-script>

<p>これを使うと</p>
<pre><code class="language-php"><span class="hljs-variable">$result</span>-&gt;interval-&gt;editor-&gt;doc_count
</code></pre>
<p>となる。</p>
<p>……あんまり変わってないじゃん！と思うかもしれないが、これをtwigから呼ぶと</p>
<pre><code class="language-twig"><span class="hljs-template-variable">{{ result[<span class="hljs-string">&#x27;interval&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>][<span class="hljs-string">&#x27;editor&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>][<span class="hljs-string">&#x27;doc_count&#x27;</span>] }}</span>
</code></pre>
<p>が</p>
<pre><code class="language-twig"><span class="hljs-template-variable">{{ result.interval.editor.doc_count }}</span>
</code></pre>
<p>になったり</p>
<pre><code class="language-twig"><span class="hljs-template-tag">{%</span> <span class="hljs-name">for</span> interval <span class="hljs-keyword">in</span> result[<span class="hljs-string">&#x27;interval&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>] <span class="hljs-template-tag">%}</span><span class="language-xml">
    </span><span class="hljs-template-tag">{%</span> <span class="hljs-name">for</span> editor <span class="hljs-keyword">in</span> interval[<span class="hljs-string">&#x27;editor&#x27;</span>][<span class="hljs-string">&#x27;buckets&#x27;</span>] <span class="hljs-template-tag">%}</span><span class="language-xml">
        </span><span class="hljs-template-variable">{{ editor[<span class="hljs-string">&#x27;key&#x27;</span>] }}</span><span class="language-xml">: </span><span class="hljs-template-variable">{{ editor[<span class="hljs-string">&#x27;doc_count&#x27;</span>] }}</span><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
    </span><span class="hljs-template-tag">{%</span> <span class="hljs-name">endfor</span> <span class="hljs-template-tag">%}</span><span class="language-xml">
</span><span class="hljs-template-tag">{%</span> <span class="hljs-name">endfor</span> <span class="hljs-template-tag">%}</span>
</code></pre>
<p>が</p>
<pre><code class="language-twig"><span class="hljs-template-tag">{%</span> <span class="hljs-name">for</span> interval <span class="hljs-keyword">in</span> result.interval <span class="hljs-template-tag">%}</span><span class="language-xml">
    </span><span class="hljs-template-tag">{%</span> <span class="hljs-name">for</span> key, editor <span class="hljs-keyword">in</span> interval.editor <span class="hljs-template-tag">%}</span><span class="language-xml">
        </span><span class="hljs-template-variable">{{ key }}</span><span class="language-xml">: </span><span class="hljs-template-variable">{{ editor.doc_count }}</span><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
    </span><span class="hljs-template-tag">{%</span> <span class="hljs-name">endfor</span> <span class="hljs-template-tag">%}</span><span class="language-xml">
</span><span class="hljs-template-tag">{%</span> <span class="hljs-name">endfor</span> <span class="hljs-template-tag">%}</span>
</code></pre>
<p>になったら嬉しくないですか？</p>
<p>ついでに今回練習を兼ねて<a href="https://travis-ci.org/kissge/ElasticaFriendlyResultSet">Travis CI</a>での自動テスト、<a href="https://coveralls.io/github/kissge/ElasticaFriendlyResultSet">Coveralls</a>でのカバレッジレポートとかいろいろ遊んだ。なんか表示がぶっ壊れてるけど。
テスト初心者だけど、カバレッジ可視化はモチベーションにつながって良いことだと思う。
passing &amp; 100%のGitHubドヤ顔緑バッジ……もなんか出てないけど（GitHubがキャッシュするから？）。</p>
<figure><img src="/images/uploads/2016/07/Screenshot-2016-07-27-05.27.17.png" alt="図"></figure><p>ついでに<a href="https://packagist.org">Packagist</a>にも<a href="https://packagist.org/packages/kissge/elastica-friendly-result-set">登録した</a>ので</p>
<pre><code class="language-sh">composer require kissge/elastica-friendly-result-set
</code></pre>
<p>だけでインストールできるようになった。登録は一瞬で済んだ。</p>
<!-- HTML_TAG_END --></section>

    

    <section class="mentions svelte-19gm1ik"><section class="reaction svelte-19gm1ik"><a href="https://twitter.com/intent/tweet?url=" class="svelte-19gm1ik" style="background-image: url(/_app/immutable/assets/message-circle-c0b45d48.svg); color: #3579d1;"><small class="svelte-19gm1ik">Twitterで</small>
        <span class="svelte-19gm1ik">コメントする</span></a></section>

  <h1 class="svelte-19gm1ik">Mentions</h1>
  <ol reversed class="svelte-19gm1ik loading"></ol>
</section></article>
</main>

<footer>Built with <a href="https://github.com/kissge/monolog">monolog</a>
</footer>


		<script type="module" data-sveltekit-hydrate="1jhyxr6">
		import { start } from "/_app/immutable/start-ce704036.js";
		start({
			target: document.querySelector('[data-sveltekit-hydrate="1jhyxr6"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "always",
			hydrate: {
				status: 200,
				error: null,
				nodes: [0, 2],
				params: {entity:"notes\u002Felastica-friendly-result-set\u002F"},
				routeId: "[...entity]"
			}
		});
	</script><script type="application/json" sveltekit:data-type="props">{"entity":{"name":"Elasticaの戻り値をいい感じにラップするライブラリを書いた","nameSegmented":["Elasticaの","戻り","値を","いい","感じに","ラップする","ライブラリを","書いた"],"kind":"note","urlPath":"/notes/elastica-friendly-result-set","historyURL":"https://github.com/kissge/yo.eki.do/commits/master/notes/elastica-friendly-result-set.md","lastModified":"2022-04-17T12:08:43.000Z","attributes":{"from":"wordpress","title":"Elasticaの戻り値をいい感じにラップするライブラリを書いた","date":"2016-07-27T05:34:31.000Z"},"tags":[],"body":"\u003Cp>PHPでElasticSearchをあつかうときの定番ライブラリに\u003Ca href=\"https://github.com/ruflin/Elastica\">Elastica\u003C/a>というものがある。\nSymfonyで扱うときはこれをさらにラップした\u003Ca href=\"https://github.com/FriendsOfSymfony/FOSElasticaBundle\">FOSElasticaBundle\u003C/a>を使うとよい。\u003C/p>\n\u003Cp>Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。\u003C/p>\n\u003C!--more-->\n\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span> = \u003Cspan class=\"hljs-variable\">$index\u003C/span>-&gt;\u003Cspan class=\"hljs-title function_ invoke__\">search\u003C/span>(\u003Cspan class=\"hljs-variable\">$query\u003C/span>)-&gt;\u003Cspan class=\"hljs-title function_ invoke__\">getAggregations\u003C/span>()\n\u003C/code>\u003C/pre>\n\u003Cp>こんな感じで結果を取るとすると\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">[\n    \u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span> =&gt; [\n        \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n            [\n                \u003Cspan class=\"hljs-string\">&#x27;key_as_string&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;2016-05-31T15:00:00.000Z&#x27;\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1464706800000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span> =&gt; [\n                    \u003Cspan class=\"hljs-string\">&#x27;doc_count_error_upper_bound&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;sum_other_doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;Emacs&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">800\u003C/span>,\n                        ],\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;nano&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">200\u003C/span>,\n                        ],\n                    ],\n                ],\n            ],\n            [\n                \u003Cspan class=\"hljs-string\">&#x27;key_as_string&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;2016-06-30T15:00:00.000Z&#x27;\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1467298800000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">2000\u003C/span>,\n                \u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span> =&gt; [\n                    \u003Cspan class=\"hljs-string\">&#x27;doc_count_error_upper_bound&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;sum_other_doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">0\u003C/span>,\n                    \u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span> =&gt; [\n                        [\n                            \u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-string\">&#x27;SublimeText&#x27;\u003C/span>,\n                            \u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span> =&gt; \u003Cspan class=\"hljs-number\">1800\u003C/span>,\n                        ],\n                    ],\n                ],\n            ],\n        ],\n    ],\n]\n\u003C/code>\u003C/pre>\n\u003Cp>こんな感じで返ってきたりするので\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span>[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>]\n\u003C/code>\u003C/pre>\n\u003Cp>とかやって欲しいデータを取る。\nちょっと指が疲れて微妙なのでこの辺をいい感じにラップするライブラリ\u003Ca href=\"https://github.com/kissge/ElasticaFriendlyResultSet\">ElasticaFriendlyResultSet\u003C/a>を書いた。\u003C/p>\n\u003Cx-script src=\"https://cdn.jsdelivr.net/github-cards/latest/widget.js\">\n\u003Cdiv class=\"github-card\" data-github=\"kissge/ElasticaFriendlyResultSet\" data-width=\"400\" data-height=\"296\" data-theme=\"medium\">\u003C/div>\n\u003C/x-script>\n\n\u003Cp>これを使うと\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-php\">\u003Cspan class=\"hljs-variable\">$result\u003C/span>-&gt;interval-&gt;editor-&gt;doc_count\n\u003C/code>\u003C/pre>\n\u003Cp>となる。\u003C/p>\n\u003Cp>……あんまり変わってないじゃん！と思うかもしれないが、これをtwigから呼ぶと\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-variable\">{{ result[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>] }}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>が\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-variable\">{{ result.interval.editor.doc_count }}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>になったり\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> interval \u003Cspan class=\"hljs-keyword\">in\u003C/span> result[\u003Cspan class=\"hljs-string\">&#x27;interval&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>] \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> editor \u003Cspan class=\"hljs-keyword\">in\u003C/span> interval[\u003Cspan class=\"hljs-string\">&#x27;editor&#x27;\u003C/span>][\u003Cspan class=\"hljs-string\">&#x27;buckets&#x27;\u003C/span>] \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n        \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor[\u003Cspan class=\"hljs-string\">&#x27;key&#x27;\u003C/span>] }}\u003C/span>\u003Cspan class=\"language-xml\">: \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor[\u003Cspan class=\"hljs-string\">&#x27;doc_count&#x27;\u003C/span>] }}\u003C/span>\u003Cspan class=\"language-xml\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">br\u003C/span> /&gt;\u003C/span>\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n\u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>が\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-twig\">\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> interval \u003Cspan class=\"hljs-keyword\">in\u003C/span> result.interval \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">for\u003C/span> key, editor \u003Cspan class=\"hljs-keyword\">in\u003C/span> interval.editor \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n        \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ key }}\u003C/span>\u003Cspan class=\"language-xml\">: \u003C/span>\u003Cspan class=\"hljs-template-variable\">{{ editor.doc_count }}\u003C/span>\u003Cspan class=\"language-xml\">\u003Cspan class=\"hljs-tag\">&lt;\u003Cspan class=\"hljs-name\">br\u003C/span> /&gt;\u003C/span>\n    \u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\u003Cspan class=\"language-xml\">\n\u003C/span>\u003Cspan class=\"hljs-template-tag\">{%\u003C/span> \u003Cspan class=\"hljs-name\">endfor\u003C/span> \u003Cspan class=\"hljs-template-tag\">%}\u003C/span>\n\u003C/code>\u003C/pre>\n\u003Cp>になったら嬉しくないですか？\u003C/p>\n\u003Cp>ついでに今回練習を兼ねて\u003Ca href=\"https://travis-ci.org/kissge/ElasticaFriendlyResultSet\">Travis CI\u003C/a>での自動テスト、\u003Ca href=\"https://coveralls.io/github/kissge/ElasticaFriendlyResultSet\">Coveralls\u003C/a>でのカバレッジレポートとかいろいろ遊んだ。なんか表示がぶっ壊れてるけど。\nテスト初心者だけど、カバレッジ可視化はモチベーションにつながって良いことだと思う。\npassing &amp; 100%のGitHubドヤ顔緑バッジ……もなんか出てないけど（GitHubがキャッシュするから？）。\u003C/p>\n\u003Cfigure>\u003Cimg src=\"/images/uploads/2016/07/Screenshot-2016-07-27-05.27.17.png\" alt=\"図\">\u003C/figure>\u003Cp>ついでに\u003Ca href=\"https://packagist.org\">Packagist\u003C/a>にも\u003Ca href=\"https://packagist.org/packages/kissge/elastica-friendly-result-set\">登録した\u003C/a>ので\u003C/p>\n\u003Cpre>\u003Ccode class=\"language-sh\">composer require kissge/elastica-friendly-result-set\n\u003C/code>\u003C/pre>\n\u003Cp>だけでインストールできるようになった。登録は一瞬で済んだ。\u003C/p>\n","headline":"PHPでElasticSearchをあつかうときの定番ライブラリにElasticaというものがある。Symfonyで扱うときはこれをさらにラップしたFOSElasticaBundleを使うとよい。Elasticaの難点として、クエリを投げて帰ってくる結果が連想配列で得られるのだが、これが無駄に深いネストがあったりして地味に使いづらい。$result = $index-&gt;search($query)-&gt;getAggregations()こんな感じで結果を取るとすると[    &#x27;interval&#x27; =&gt; [        &#x27;buckets&#x27; =&gt; [            [                &#x27;key_as_string&#x27; =&gt; &#x27;2016-05-31T15:00:00.000Z&#x27;,                 &#x27;key&#x27; =&gt; 1464706800000,                 &#x27;doc_count&#x27; =&gt; 1000,   ","links":{"to":{"urlPath":"/notes/elastica-friendly-result-set","entities":[]},"from":{"urlPath":"/notes/elastica-friendly-result-set","entities":[]},"kind":{"urlPath":"/notes/elastica-friendly-result-set","entities":[]}}}}</script></div>
  </body>
</html>
